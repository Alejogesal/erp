{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Compras{% endblock %}
{% block content %}
<style>
    input[type="checkbox"][name$="-DELETE"] {
        display: none;
    }
</style>
<h1>Compras</h1>
<p class="subtitle">Registr치 compras y consult치 el historial.</p>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Registrar compra</div>
    <form method="post" action="{% url 'inventory_purchases_list' %}">
        {% csrf_token %}
        <input type="hidden" name="items_payload" id="items-payload">
        <h3>Dep칩sito</h3>
        <p>
            {{ form.warehouse.label_tag }}
            {{ form.warehouse }}
            {{ form.warehouse.errors }}
        </p>
        <p>
            {{ form.purchase_date.label_tag }}
            <div style="display:flex; gap:8px; align-items:center;">
                {{ form.purchase_date }}
                <button type="button" class="pill date-picker-btn" style="font-size:12px; padding:4px 8px;">游늰</button>
            </div>
            {{ form.purchase_date.errors }}
        </p>
        <p>
            {{ form.descuento_total.label_tag }}
            {{ form.descuento_total }}
            {{ form.descuento_total.errors }}
        </p>
        {{ formset.non_form_errors }}
        <h3>Productos</h3>
        {{ formset.management_form }}
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Proveedor</th>
                    <th>Cantidad</th>
                    <th>Costo unitario</th>
                    <th>DTO %</th>
                    <th class="vat-col">IVA %</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="items-body">
                {% for item_form in formset.forms %}
                <tr>
                    <td>{{ item_form.product }}</td>
                    <td>{{ item_form.supplier }}</td>
                    <td>{{ item_form.quantity }}</td>
                    <td>{{ item_form.unit_cost }}</td>
                    <td>{{ item_form.discount_percent }}</td>
                    <td class="vat-col">{{ item_form.vat_percent }}</td>
                    <td>
                        {% if formset.can_delete %}
                        {{ item_form.DELETE }}
                        <button type="button" class="pill delete-row" style="font-size:12px; padding:4px 8px;">Eliminar</button>
                        {% endif %}
                    </td>
                </tr>
                {% if item_form.errors %}
                <tr>
                    <td colspan="7">{{ item_form.errors }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="toggle-vat">Mostrar IVA</button>
        <button type="button" id="add-item">Agregar producto</button>
        <button type="submit">Registrar compra</button>
    </form>
</div>

<div class="card table-card">
    <div class="card-title" style="display:flex; align-items:center; justify-content:space-between;">
        <span>Historial de compras</span>
        {% if not show_history %}
        <a class="pill" href="?show_history=1" style="font-size:12px; padding:4px 8px;">Cargar historial</a>
        {% endif %}
    </div>
    {% if show_history %}
    <table>
        <thead>
            <tr>
                <th>Comprobante</th>
                <th>Fecha</th>
                <th>Proveedor</th>
                <th>Dep칩sito</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
            <tr>
                <td>{{ purchase.invoice_number }}</td>
                <td>{{ purchase.created_at|date:"d/m/Y H:i" }}</td>
                <td>{{ purchase.supplier|default:"-" }}</td>
                <td>{{ purchase.warehouse.name }}</td>
                <td>${{ purchase.total|latam_number:2 }}</td>
                <td>
                    <a class="pill" href="{% url 'inventory_purchase_receipt' purchase.id %}">Ver</a>
                    <a class="pill" href="{% url 'inventory_purchase_edit' purchase.id %}">Editar</a>
                    <form method="post" action="{% url 'inventory_purchase_delete' purchase.id %}" style="display:inline;" onsubmit="return confirm('쮼liminar esta compra? Se revertir치 el stock.');">
                        {% csrf_token %}
                        <button type="submit">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6">A칰n no hay compras registradas.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        {% if page_obj.has_previous %}
        <a class="pill" href="?show_history=1&page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}
        <span style="align-self:center; color:var(--muted); font-size:12px;">
            P치gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_next %}
        <a class="pill" href="?show_history=1&page={{ page_obj.next_page_number }}">Siguiente</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <p class="subtitle" style="margin-top:8px;">Historial oculto. Toc치 "Cargar historial".</p>
    {% endif %}
</div>

<script>
    (function() {
        const addBtn = document.getElementById("add-item");
        const toggleVat = document.getElementById("toggle-vat");
        const body = document.getElementById("items-body");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        const productInfoUrl = "{% url 'inventory_product_info' %}";
        const productSearchUrl = "{% url 'inventory_product_search' %}";
        const productInfoCache = new Map();
        const productSearchCache = new Map();
        if (!addBtn || !body || !totalForms) return;

        const parseNumber = (value) => {
            if (!value) return 0;
            const raw = String(value).replace(/\s/g, "");
            let normalized = raw;
            const hasComma = raw.includes(",");
            const hasDot = raw.includes(".");
            if (hasComma && hasDot) {
                normalized = raw.replace(/\./g, "").replace(",", ".");
            } else if (hasComma) {
                normalized = raw.replace(",", ".");
            }
            const parsed = parseFloat(normalized);
            return Number.isNaN(parsed) ? 0 : parsed;
        };

        const formatNumber = (value) => Number(value || 0).toFixed(2);

        const setRowCost = (row, costInput, value) => {
            if (!row || !costInput) return;
            row.dataset.autoUpdating = "1";
            costInput.value = value;
            row.dataset.autoUpdating = "0";
        };

        const updateBaseFromCurrent = (row) => {
            if (!row) return;
            const costInput = row.querySelector("input[name$='-unit_cost']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            if (!costInput || !vatInput) return;
            const cost = parseNumber(costInput.value);
            const vat = parseNumber(vatInput.value);
            if (!cost) return;
            const factor = 1 + vat / 100;
            const base = factor > 0 ? cost / factor : cost;
            row.dataset.baseCost = String(base);
        };

        const applyVatToCost = (row) => {
            if (!row) return;
            const costInput = row.querySelector("input[name$='-unit_cost']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            if (!costInput || !vatInput) return;
            const base = parseNumber(row.dataset.baseCost || "");
            if (!base) return;
            const vat = parseNumber(vatInput.value);
            const total = base * (1 + vat / 100);
            setRowCost(row, costInput, formatNumber(total));
        };

        const setupRow = (row) => {
            if (!row || row.dataset.costReady === "1") return;
            row.dataset.costReady = "1";
            const costInput = row.querySelector("input[name$='-unit_cost']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            if (costInput) {
                costInput.addEventListener("input", () => {
                    if (row.dataset.autoUpdating === "1") return;
                    updateBaseFromCurrent(row);
                });
            }
            if (vatInput) {
                vatInput.addEventListener("input", () => applyVatToCost(row));
            }
            updateBaseFromCurrent(row);
        };

        const fetchProductInfo = async (productId) => {
            if (!productId) return null;
            if (productInfoCache.has(productId)) return productInfoCache.get(productId);
            try {
                const resp = await fetch(`${productInfoUrl}?product_id=${encodeURIComponent(productId)}`, {
                    credentials: "same-origin",
                });
                if (!resp.ok) return null;
                const data = await resp.json();
                productInfoCache.set(productId, data);
                return data;
            } catch (err) {
                return null;
            }
        };
        const applyProductDefaults = async (productSelect) => {
            if (!productSelect) return;
            const row = productSelect.closest("tr");
            if (!row) return;
            const supplierSelect = row.querySelector("select[name$='-supplier']");
            const costInput = row.querySelector("input[name$='-unit_cost']");
            const productId = productSelect.value;
            const previousProductId = row.dataset.productId || "";
            const info = await fetchProductInfo(productId);
            if (!info) return;
            if (productId) {
                row.dataset.productId = String(productId);
            }
            const productChanged = previousProductId && String(previousProductId) !== String(productId);
            if (supplierSelect && info.default_supplier_id) {
                supplierSelect.value = String(info.default_supplier_id);
            }
            if (info.avg_cost) {
                row.dataset.baseCost = String(info.avg_cost);
            }
            if (costInput && info.avg_cost && (!costInput.value || productChanged)) {
                setRowCost(row, costInput, formatNumber(parseNumber(info.avg_cost)));
            }
            if (!costInput?.value || productChanged) {
                updateBaseFromCurrent(row);
                applyVatToCost(row);
            }
        };

        const ensureSelectOption = (selectEl, productId, label) => {
            if (!selectEl || !productId) return;
            const idValue = String(productId);
            let option = Array.from(selectEl.options || []).find((opt) => opt.value === idValue);
            if (!option) {
                selectEl.innerHTML = "";
                option = document.createElement("option");
                option.value = idValue;
                option.textContent = label || `Producto #${idValue}`;
                selectEl.appendChild(option);
            } else if (label && option.textContent !== label) {
                option.textContent = label;
            }
            selectEl.value = idValue;
        };

        const fetchProductSearch = async (term) => {
            if (productSearchCache.has(term)) return productSearchCache.get(term);
            try {
                const resp = await fetch(`${productSearchUrl}?q=${encodeURIComponent(term)}`, {
                    credentials: "same-origin",
                });
                if (!resp.ok) return [];
                const data = await resp.json();
                const results = Array.isArray(data.results) ? data.results : [];
                productSearchCache.set(term, results);
                return results;
            } catch (err) {
                return [];
            }
        };

        const populateDatalist = (datalist, results) => {
            if (!datalist) return;
            datalist.innerHTML = "";
            results.forEach((item) => {
                const option = document.createElement("option");
                option.value = item.label || "";
                option.dataset.id = item.id;
                if (item.default_supplier_id) {
                    option.dataset.defaultSupplierId = item.default_supplier_id;
                }
                if (item.avg_cost) {
                    option.dataset.avgCost = item.avg_cost;
                }
                if (item.cost_with_vat) {
                    option.dataset.costWithVat = item.cost_with_vat;
                }
                datalist.appendChild(option);
            });
        };

        const updateSearchFromSelect = (selectEl) => {
            const searchInput = selectEl?._searchInput;
            if (!searchInput) return;
            const selectedText = selectEl.options[selectEl.selectedIndex]?.textContent || "";
            searchInput.value = selectedText;
        };

        const setupProductSearch = (selectEl) => {
            if (!selectEl) return;
            if (selectEl.dataset.searchReady === "1") return;
            selectEl.dataset.searchReady = "1";
            selectEl.style.display = "none";
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.gap = "6px";
            const search = document.createElement("input");
            search.type = "text";
            search.placeholder = "Buscar producto...";
            search.name = (selectEl.name || "").replace("-product", "-product_text");
            const datalist = document.createElement("datalist");
            const listId = `product-options-${Math.random().toString(36).slice(2)}`;
            datalist.id = listId;
            search.setAttribute("list", listId);
            selectEl._searchInput = search;
            selectEl._searchList = datalist;
            selectEl.parentElement.insertBefore(wrapper, selectEl);
            wrapper.appendChild(search);
            wrapper.appendChild(datalist);
            wrapper.appendChild(selectEl);
            const initialLabel = selectEl.options[selectEl.selectedIndex]?.textContent || "";
            if (initialLabel) {
                search.value = initialLabel;
            }

            let searchTimer = null;
            search.addEventListener("input", () => {
                const term = (search.value || "").trim();
                if (term.length < 2) {
                    datalist.innerHTML = "";
                    return;
                }
                if (searchTimer) window.clearTimeout(searchTimer);
                searchTimer = window.setTimeout(async () => {
                    const results = await fetchProductSearch(term);
                    populateDatalist(datalist, results);
                }, 200);
            });

            const syncSelection = () => {
                const raw = (search.value || "").trim();
                if (!raw) return;
                const opts = Array.from(datalist.options || []);
                let match = opts.find((opt) => opt.value === raw);
                if (!match) {
                    const lowered = raw.toLowerCase();
                    match = opts.find((opt) => (opt.value || "").toLowerCase() === lowered);
                }
                if (!match) {
                    const lowered = raw.toLowerCase();
                    const candidates = opts.filter((opt) => (opt.value || "").toLowerCase().includes(lowered));
                    if (candidates.length >= 1) {
                        match = candidates[0];
                    }
                }
                if (match) {
                    const productId = match.dataset.id;
                    const label = match.value || raw;
                    ensureSelectOption(selectEl, productId, label);
                    if (productId) {
                        productInfoCache.set(productId, {
                            ok: true,
                            default_supplier_id: match.dataset.defaultSupplierId || null,
                            avg_cost: match.dataset.avgCost || null,
                            cost_with_vat: match.dataset.costWithVat || null,
                        });
                    }
                    applyProductDefaults(selectEl);
                    updateSearchFromSelect(selectEl);
                }
            };
            selectEl._syncSelection = syncSelection;
            search.addEventListener("change", syncSelection);
            search.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    syncSelection();
                }
            });
            requestAnimationFrame(() => updateSearchFromSelect(selectEl));
        };

        document.querySelectorAll("select[name$='-product']").forEach(setupProductSearch);
        document.querySelectorAll("select[name$='-product']").forEach(applyProductDefaults);
        document.querySelectorAll("#items-body tr").forEach(setupRow);
        document.querySelectorAll("input[type='checkbox'][name$='-DELETE']").forEach((checkbox) => {
            checkbox.style.display = "none";
        });

        addBtn.addEventListener("click", () => {
            const idx = parseInt(totalForms.value, 10);
            const emptyHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, `form-${idx}`);
            const container = document.createElement("div");
            container.innerHTML = emptyHtml;

            const tr = document.createElement("tr");
            const product = container.querySelector("[name$='-product']");
            const supplier = container.querySelector("[name$='-supplier']");
            const qty = container.querySelector("[name$='-quantity']");
            const cost = container.querySelector("[name$='-unit_cost']");
            const discount = container.querySelector("[name$='-discount_percent']");
            const vat = container.querySelector("[name$='-vat_percent']");
            const deleteField = container.querySelector("[name$='-DELETE']");

            [product, supplier, qty, cost, discount, vat].forEach(field => {
                const td = document.createElement("td");
                if (field) td.appendChild(field);
                if (field && field.name?.includes("vat_percent")) td.classList.add("vat-col");
                tr.appendChild(td);
            });
            const deleteTd = document.createElement("td");
            if (deleteField) {
                deleteField.style.display = "none";
                deleteTd.appendChild(deleteField);
                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.className = "pill delete-row";
                deleteBtn.style.fontSize = "12px";
                deleteBtn.style.padding = "4px 8px";
                deleteBtn.textContent = "Eliminar";
                deleteTd.appendChild(deleteBtn);
            }
            tr.appendChild(deleteTd);

            totalForms.value = idx + 1;
            body.appendChild(tr);
            setupProductSearch(tr.querySelector("select[name$='-product']"));
            setupRow(tr);
            if (vatHidden) {
                tr.querySelectorAll(".vat-col").forEach((col) => {
                    col.style.display = "none";
                });
            }
        });

        let vatHidden = false;
        if (toggleVat) {
            toggleVat.addEventListener("click", () => {
                const cols = document.querySelectorAll(".vat-col");
                cols.forEach((col) => {
                    col.style.display = col.style.display === "none" ? "" : "none";
                });
                vatHidden = Array.from(cols).every((col) => col.style.display === "none");
            });
            document.querySelectorAll(".vat-col").forEach((col) => (col.style.display = "none"));
            vatHidden = true;
        }

        document.addEventListener("click", (event) => {
            const btn = event.target.closest(".delete-row");
            if (!btn) return;
            const row = btn.closest("tr");
            const checkbox = row?.querySelector("input[type='checkbox'][name$='-DELETE']");
            if (checkbox) {
                checkbox.checked = true;
                row.remove();
            }
        });

        const formEl = addBtn.closest("form");
        const storageKey = "erp:purchases_draft";
        const resolveProductId = (productSelect) => {
            if (!productSelect) return "";
            if (productSelect.value) return productSelect.value;
            const searchValue = productSelect._searchInput?.value?.trim() || "";
            if (!searchValue) return "";
            const options = Array.from(productSelect._searchList?.options || []);
            let match = options.find((opt) => (opt.value || "") === searchValue);
            if (!match) {
                const lowered = searchValue.toLowerCase();
                match = options.find((opt) => (opt.value || "").toLowerCase() === lowered);
            }
            if (!match) {
                const lowered = searchValue.toLowerCase();
                const candidates = options.filter((opt) => (opt.value || "").toLowerCase().includes(lowered));
                if (candidates.length) match = candidates[0];
            }
            return match?.dataset?.id || "";
        };

        const serializeRow = (row) => {
            const productSelect = row.querySelector("select[name$='-product']");
            const supplierSelect = row.querySelector("select[name$='-supplier']");
            const qtyInput = row.querySelector("input[name$='-quantity']");
            const costInput = row.querySelector("input[name$='-unit_cost']");
            const discountInput = row.querySelector("input[name$='-discount_percent']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            const searchInput = productSelect?._searchInput;
            const data = {
                product_id: resolveProductId(productSelect),
                product_text: searchInput?.value || "",
                product_search: searchInput?.value || "",
                supplier_id: supplierSelect?.value || "",
                quantity: qtyInput?.value || "",
                unit_cost: costInput?.value || "",
                discount_percent: discountInput?.value || "",
                vat_percent: vatInput?.value || "",
            };
            const hasValue = Object.values(data).some((value) => value);
            return hasValue ? data : null;
        };

        let suppressDraftSave = false;
        const saveDraft = () => {
            if (suppressDraftSave) return;
            if (!formEl) return;
            const warehouseSelect = formEl.querySelector("select[name='warehouse']");
            const rows = Array.from(body.querySelectorAll("tr"));
            const items = rows.map(serializeRow).filter(Boolean);
            const payload = {
                warehouse: warehouseSelect?.value || "",
                items,
            };
            localStorage.setItem(storageKey, JSON.stringify(payload));
        };

        const fillRow = (row, data) => {
            if (!data) return;
            const productSelect = row.querySelector("select[name$='-product']");
            const supplierSelect = row.querySelector("select[name$='-supplier']");
            const qtyInput = row.querySelector("input[name$='-quantity']");
            const costInput = row.querySelector("input[name$='-unit_cost']");
            const discountInput = row.querySelector("input[name$='-discount_percent']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            if (productSelect) {
                if (data.product_id) {
                    ensureSelectOption(productSelect, data.product_id, data.product_text || data.product_search);
                    updateSearchFromSelect(productSelect);
                } else if (productSelect._searchInput) {
                    productSelect._searchInput.value = data.product_search || "";
                }
                setSupplierIfAvailable(productSelect);
                setCostIfAvailable(productSelect);
            }
            if (supplierSelect && data.supplier_id) supplierSelect.value = data.supplier_id;
            if (qtyInput && data.quantity) qtyInput.value = data.quantity;
            if (costInput && data.unit_cost) costInput.value = data.unit_cost;
            if (discountInput && data.discount_percent) discountInput.value = data.discount_percent;
            if (vatInput && data.vat_percent) vatInput.value = data.vat_percent;
        };

        const restoreDraft = () => {
            const navEntry = performance.getEntriesByType?.("navigation")?.[0];
            const wasReload = navEntry ? navEntry.type === "reload" : performance.navigation?.type === 1;
            if (!wasReload) {
                localStorage.removeItem(storageKey);
                return;
            }
            const raw = localStorage.getItem(storageKey);
            if (!raw) return;
            let draft = null;
            try {
                draft = JSON.parse(raw);
            } catch (err) {
                return;
            }
            const warehouseSelect = formEl?.querySelector("select[name='warehouse']");
            if (warehouseSelect && draft?.warehouse) {
                warehouseSelect.value = draft.warehouse;
            }
            const items = Array.isArray(draft?.items) ? draft.items : [];
            if (!items.length) return;
            while (body.querySelectorAll("tr").length < items.length) {
                addBtn.click();
            }
            const rows = Array.from(body.querySelectorAll("tr"));
            items.forEach((item, idx) => fillRow(rows[idx], item));
        };

        const pruneEmptyRows = () => {
            const rows = Array.from(body.querySelectorAll("tr"));
            rows.forEach((row) => {
                const productSelect = row.querySelector("select[name$='-product']");
                const qtyInput = row.querySelector("input[name$='-quantity']");
                const costInput = row.querySelector("input[name$='-unit_cost']");
                const supplierSelect = row.querySelector("select[name$='-supplier']");
                const discountInput = row.querySelector("input[name$='-discount_percent']");
                const vatInput = row.querySelector("input[name$='-vat_percent']");
                const deleteCheckbox = row.querySelector("input[type='checkbox'][name$='-DELETE']");
                if (!productSelect || !qtyInput || !costInput || !deleteCheckbox) return;
                const qtyRaw = (qtyInput.value || "").trim();
                const costRaw = (costInput.value || "").trim();
                const qtyZeroish = !qtyRaw || qtyRaw === "0" || qtyRaw === "0.0" || qtyRaw === "0.00" || qtyRaw === "0,00";
                const costZeroish = !costRaw || costRaw === "0" || costRaw === "0.0" || costRaw === "0.00" || costRaw === "0,00";
                const isEmpty = !productSelect.value && qtyZeroish && costZeroish;
                if (isEmpty) {
                    deleteCheckbox.checked = true;
                    if (supplierSelect) supplierSelect.value = "";
                    if (discountInput) discountInput.value = "";
                    if (vatInput) vatInput.value = "";
                }
            });
        };

        formEl?.addEventListener("input", saveDraft);
        formEl?.addEventListener("change", saveDraft);
        window.addEventListener("beforeunload", saveDraft);
        window.addEventListener("pagehide", saveDraft);
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") saveDraft();
        });
        formEl?.addEventListener("submit", () => {
            suppressDraftSave = true;
            document.querySelectorAll("input[name$='-unit_cost'], input[name$='-vat_percent'], input[name$='-discount_percent']").forEach((input) => {
                if (typeof input.value === "string" && input.value.includes(",")) {
                    input.value = input.value.replace(",", ".");
                }
            });
            const payloadInput = document.getElementById("items-payload");
            if (payloadInput) {
                const rows = Array.from(body.querySelectorAll("tr"));
                const items = rows.map(serializeRow).filter(Boolean);
                payloadInput.value = JSON.stringify(items);
            }
            document.querySelectorAll("select[name$='-product']").forEach((selectEl) => {
                if (typeof selectEl._syncSelection === "function") {
                    selectEl._syncSelection();
                }
            });
            pruneEmptyRows();
            localStorage.removeItem(storageKey);
        });
        restoreDraft();
    })();

    (function() {
        const buttons = document.querySelectorAll(".date-picker-btn");
        buttons.forEach((btn) => {
            const input = btn.closest("p")?.querySelector("input[type='date']");
            if (!input) return;
            btn.addEventListener("click", () => {
                if (typeof input.showPicker === "function") {
                    input.showPicker();
                } else {
                    input.focus();
                }
            });
        });
    })();
</script>
{% endblock %}
