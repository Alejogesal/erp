{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Compras{% endblock %}
{% block content %}
<h1>Compras</h1>
<p class="subtitle">Registrá compras y consultá el historial.</p>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Registrar compra</div>
    <form method="post" action="{% url 'inventory_purchases_list' %}">
        {% csrf_token %}
        <h3>Depósito</h3>
        {{ form.as_p }}
        {{ formset.non_form_errors }}
        <h3>Productos</h3>
        {{ formset.management_form }}
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Proveedor</th>
                    <th>Cantidad</th>
                    <th>Costo unitario</th>
                <th class="vat-col">IVA %</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="items-body">
                {% for item_form in formset.forms %}
                <tr>
                    <td>{{ item_form.product }}</td>
                    <td>{{ item_form.supplier }}</td>
                    <td>{{ item_form.quantity }}</td>
                    <td>{{ item_form.unit_cost }}</td>
                    <td class="vat-col">{{ item_form.vat_percent }}</td>
                    <td>
                        {% if formset.can_delete %}
                        {{ item_form.DELETE }}
                        <button type="button" class="pill delete-row" style="font-size:12px; padding:4px 8px;">Eliminar</button>
                        {% endif %}
                    </td>
                </tr>
                {% if item_form.errors %}
                <tr>
                    <td colspan="6">{{ item_form.errors }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="toggle-vat">Mostrar IVA</button>
        <button type="button" id="add-item">Agregar producto</button>
        <button type="submit">Registrar compra</button>
    </form>
</div>

<div class="card table-card">
    <div class="card-title">Historial de compras</div>
    <table>
        <thead>
            <tr>
                <th>Comprobante</th>
                <th>Fecha</th>
                <th>Proveedor</th>
                <th>Depósito</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
            <tr>
                <td>{{ purchase.invoice_number }}</td>
                <td>{{ purchase.created_at|date:"d/m/Y H:i" }}</td>
                <td>{{ purchase.supplier|default:"-" }}</td>
                <td>{{ purchase.warehouse.name }}</td>
                <td>${{ purchase.total|latam_number:2 }}</td>
                <td>
                    <a class="pill" href="{% url 'inventory_purchase_receipt' purchase.id %}">Ver</a>
                    <a class="pill" href="{% url 'inventory_purchase_edit' purchase.id %}">Editar</a>
                    <form method="post" action="{% url 'inventory_purchase_delete' purchase.id %}" style="display:inline;" onsubmit="return confirm('¿Eliminar esta compra? Se revertirá el stock.');">
                        {% csrf_token %}
                        <button type="submit">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6">Aún no hay compras registradas.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{{ supplier_autofill|json_script:"supplier-autofill" }}
<script>
    (function() {
        const addBtn = document.getElementById("add-item");
        const toggleVat = document.getElementById("toggle-vat");
        const body = document.getElementById("items-body");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        const supplierMap = JSON.parse(document.getElementById("supplier-autofill")?.textContent || "{}");
        if (!addBtn || !body || !totalForms) return;

        const setSupplierIfAvailable = (productSelect) => {
            if (!productSelect) return;
            const row = productSelect.closest("tr");
            const supplierSelect = row?.querySelector("select[name$='-supplier']");
            if (!supplierSelect) return;
            const productId = productSelect.value;
            const supplierId = supplierMap[productId];
            if (supplierId) {
                supplierSelect.value = String(supplierId);
            }
        };

        const setupProductSearch = (selectEl) => {
            if (!selectEl) return;
            if (selectEl.dataset.searchReady === "1") return;
            selectEl.dataset.searchReady = "1";
            selectEl.style.display = "none";
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.gap = "6px";
            const search = document.createElement("input");
            search.type = "text";
            search.placeholder = "Buscar producto...";
            const datalist = document.createElement("datalist");
            const listId = `product-options-${Math.random().toString(36).slice(2)}`;
            datalist.id = listId;
            search.setAttribute("list", listId);
            Array.from(selectEl.options).forEach((opt) => {
                const option = document.createElement("option");
                option.value = opt.textContent || "";
                option.dataset.value = opt.value;
                datalist.appendChild(option);
            });
            selectEl.parentElement.insertBefore(wrapper, selectEl);
            wrapper.appendChild(search);
            wrapper.appendChild(datalist);
            wrapper.appendChild(selectEl);

            const syncSelection = () => {
                const match = Array.from(datalist.options).find((opt) => opt.value === search.value);
                if (match) {
                    selectEl.value = match.dataset.value || "";
                    setSupplierIfAvailable(selectEl);
                }
            };
            search.addEventListener("change", syncSelection);
            search.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    syncSelection();
                }
            });
        };

        document.querySelectorAll("select[name$='-product']").forEach(setupProductSearch);
        document.querySelectorAll("select[name$='-product']").forEach(setSupplierIfAvailable);
        document.querySelectorAll("input[type='checkbox'][name$='-DELETE']").forEach((checkbox) => {
            checkbox.style.display = "none";
        });

        addBtn.addEventListener("click", () => {
            const idx = parseInt(totalForms.value, 10);
            const emptyHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, `form-${idx}`);
            const container = document.createElement("div");
            container.innerHTML = emptyHtml;

            const tr = document.createElement("tr");
            const product = container.querySelector("[name$='-product']");
            const supplier = container.querySelector("[name$='-supplier']");
            const qty = container.querySelector("[name$='-quantity']");
            const cost = container.querySelector("[name$='-unit_cost']");
            const vat = container.querySelector("[name$='-vat_percent']");
            const deleteField = container.querySelector("[name$='-DELETE']");

            [product, supplier, qty, cost, vat].forEach(field => {
                const td = document.createElement("td");
                if (field) td.appendChild(field);
                if (field && field.name?.includes("vat_percent")) td.classList.add("vat-col");
                tr.appendChild(td);
            });
            const deleteTd = document.createElement("td");
            if (deleteField) {
                deleteField.style.display = "none";
                deleteTd.appendChild(deleteField);
                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.className = "pill delete-row";
                deleteBtn.style.fontSize = "12px";
                deleteBtn.style.padding = "4px 8px";
                deleteBtn.textContent = "Eliminar";
                deleteTd.appendChild(deleteBtn);
            }
            tr.appendChild(deleteTd);

            totalForms.value = idx + 1;
            body.appendChild(tr);
            setupProductSearch(tr.querySelector("select[name$='-product']"));
        });

        if (toggleVat) {
            toggleVat.addEventListener("click", () => {
                const cols = document.querySelectorAll(".vat-col");
                cols.forEach((col) => {
                    col.style.display = col.style.display === "none" ? "" : "none";
                });
            });
            document.querySelectorAll(".vat-col").forEach((col) => (col.style.display = "none"));
        }

        document.addEventListener("click", (event) => {
            const btn = event.target.closest(".delete-row");
            if (!btn) return;
            const row = btn.closest("tr");
            const checkbox = row?.querySelector("input[type='checkbox'][name$='-DELETE']");
            if (checkbox) {
                checkbox.checked = true;
                row.style.opacity = "0.45";
            }
        });
    })();
</script>
{% endblock %}
