{% extends "inventory/base.html" %}
{% block title %}Registrar venta{% endblock %}
{% block content %}
<h1>Registrar venta</h1>
<p class="subtitle">Dá de baja stock según el depósito elegido.</p>
<div class="card">
    <form method="post">
        {% csrf_token %}
        <h3>Datos de la venta</h3>
        {{ form.as_p }}
        {{ formset.non_form_errors }}
        <h3>Productos</h3>
        {{ formset.management_form }}
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Variedad</th>
                    <th>Cantidad</th>
                    <th>IVA %</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="items-body">
                {% for item_form in formset.forms %}
                <tr>
                    <td>{{ item_form.product }}</td>
                    <td>
                        <select name="{{ item_form.prefix }}-variant_id" class="variant-select" data-selected=""></select>
                    </td>
                    <td>{{ item_form.quantity }}</td>
                    <td>{{ item_form.vat_percent }}</td>
                    <td>{% if formset.can_delete %}{{ item_form.DELETE }}{% endif %}</td>
                </tr>
                {% if item_form.errors %}
                <tr>
                    <td colspan="5">{{ item_form.errors }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="add-item">Agregar producto</button>
        <button type="submit">Registrar venta</button>
    </form>
</div>
{{ customer_audiences|json_script:"customer-audiences" }}
{{ variant_data|json_script:"sale-variant-data" }}
<script>
    (function() {
        const addBtn = document.getElementById("add-item");
        const body = document.getElementById("items-body");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        const customerSelect = document.getElementById("id_cliente");
        const audienceSelect = document.getElementById("id_audiencia");
        const audiences = JSON.parse(document.getElementById("customer-audiences").textContent || "{}");

        function syncAudience() {
            if (!customerSelect || !audienceSelect) return;
            const customerId = customerSelect.value;
            if (customerId && audiences[customerId]) {
                audienceSelect.value = audiences[customerId];
                audienceSelect.disabled = true;
            } else {
                audienceSelect.disabled = false;
            }
        }

        if (customerSelect) {
            customerSelect.addEventListener("change", syncAudience);
            syncAudience();
        }

        const variantDataNode = document.getElementById("sale-variant-data");
        const variantData = variantDataNode ? JSON.parse(variantDataNode.textContent) : {};
        const updateVariantSelect = (selectEl) => {
            const row = selectEl?.closest("tr");
            const variantSelect = row?.querySelector("select[name$='-variant_id']");
            if (!variantSelect) return;
            const productId = selectEl.value;
            const variants = variantData[productId] || [];
            variantSelect.innerHTML = "";
            if (!variants.length) {
                const option = document.createElement("option");
                option.value = "";
                option.textContent = "Sin variedades";
                variantSelect.appendChild(option);
                variantSelect.disabled = true;
                return;
            }
            const empty = document.createElement("option");
            empty.value = "";
            empty.textContent = "Seleccioná variedad";
            variantSelect.appendChild(empty);
            variants.forEach((variant) => {
                const option = document.createElement("option");
                option.value = variant.id;
                option.textContent = variant.name;
                variantSelect.appendChild(option);
            });
            variantSelect.disabled = false;
            const selected = variantSelect.dataset.selected || "";
            if (selected) {
                variantSelect.value = selected;
            }
        };

        document.querySelectorAll("select[name$='-product']").forEach((selectEl) => {
            selectEl.addEventListener("change", () => updateVariantSelect(selectEl));
            updateVariantSelect(selectEl);
        });

        addBtn.addEventListener("click", () => {
            const idx = parseInt(totalForms.value, 10);
            const emptyHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, `${idx}`);
            const container = document.createElement("div");
            container.innerHTML = emptyHtml;

            const tr = document.createElement("tr");
            const product = container.querySelector("[name$='-product']");
            const variant = document.createElement("select");
            variant.name = `form-${idx}-variant_id`;
            variant.className = "variant-select";
            variant.dataset.selected = "";
            const qty = container.querySelector("[name$='-quantity']");
            const vat = container.querySelector("[name$='-vat_percent']");
            const deleteField = container.querySelector("[name$='-DELETE']");

            [product, variant, qty, vat, deleteField].forEach(field => {
                const td = document.createElement("td");
                if (field) td.appendChild(field);
                tr.appendChild(td);
            });

            totalForms.value = idx + 1;
            body.appendChild(tr);
            if (product) {
                product.addEventListener("change", () => updateVariantSelect(product));
                updateVariantSelect(product);
            }
        });

        const formEl = addBtn.closest("form");
        formEl?.addEventListener("submit", () => {
            const rows = Array.from(body.querySelectorAll("tr"));
            let total = parseInt(totalForms.value, 10);
            const isEmptyRow = (row) => {
                const product = row.querySelector("select[name$='-product']");
                const qty = row.querySelector("input[name$='-quantity']");
                const productValue = (product?.value || "").trim();
                const qtyValue = (qty?.value || "").trim();
                return !productValue && !qtyValue;
            };
            while (rows.length && isEmptyRow(rows[rows.length - 1])) {
                rows[rows.length - 1].remove();
                rows.pop();
                total = Math.max(0, total - 1);
            }
            totalForms.value = total;
        });
    })();
</script>
{% endblock %}
