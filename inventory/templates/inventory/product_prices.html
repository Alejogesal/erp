{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Lista de precios{% endblock %}
{% block content %}
<h1>Lista de precios</h1>
<p class="subtitle">Precios diferenciados por canal.</p>
<style>
    .price-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #0f1622;
        border: 1px solid #2a313c;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        margin: 8px 0 12px;
    }
    .price-filter input {
        background: transparent;
        border: none;
        color: var(--text);
        width: 100%;
        padding: 4px 2px;
        font-size: 14px;
    }
    .price-filter input:focus { outline: none; }
    .price-filter .hint {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.3px;
        text-transform: uppercase;
        white-space: nowrap;
    }
    .price-input {
        background: #0f1622;
        border: 1px solid #2a313c;
        color: var(--text);
        border-radius: 8px;
        padding: 6px 8px;
        font-size: 13px;
        max-width: 110px;
    }
    .price-input::placeholder {
        color: var(--muted);
    }
</style>

<div class="actions" style="margin-bottom:16px;">
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'consumer' %}" href="{% url 'inventory_product_prices_download' 'consumer' %}">Descargar consumidor final</a>
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'barber' %}" href="{% url 'inventory_product_prices_download' 'barber' %}">Descargar peluquerías/barberías</a>
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'distributor' %}" href="{% url 'inventory_product_prices_download' 'distributor' %}">Descargar distribuidores</a>
</div>

<datalist id="group-options">
    {% for group in group_options %}
        <option value="{{ group }}"></option>
    {% endfor %}
</datalist>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Crear kit</div>
    <form method="post" action="{% url 'inventory_product_prices' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_kit">
        <div class="product-form-grid">
            <div class="full">
                <label for="kit-name">Nombre</label>
                <input id="kit-name" name="kit_name" required>
            </div>
            <div>
                <label for="kit-sku">SKU (opcional)</label>
                <input id="kit-sku" name="kit_sku">
            </div>
            <div>
                <label for="kit-group">Marca / Grupo</label>
                <input id="kit-group" name="kit_group" list="group-options">
            </div>
            <div>
                <label for="kit-price-dist">Precio distribuidor (fijo)</label>
                <input id="kit-price-dist" name="kit_price_distributor" placeholder="0,00">
            </div>
            <div>
                <label for="kit-margin-barber">Margen barberías %</label>
                <input id="kit-margin-barber" name="kit_margin_barber" placeholder="0,00">
            </div>
            <div>
                <label for="kit-margin-consumer">Margen consumidor %</label>
                <input id="kit-margin-consumer" name="kit_margin_consumer" placeholder="0,00">
            </div>
        </div>
        <div id="kit-items"></div>
        <button type="button" id="kit-add-item">Agregar producto al kit</button>
        <button type="submit">Guardar kit</button>
    </form>
</div>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Editar kit</div>
    <form method="post" action="{% url 'inventory_product_prices' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_kit">
        <div class="product-form-grid">
            <div class="full">
                <label for="kit-edit-id">Kit</label>
                <select id="kit-edit-id" name="kit_id">
                    <option value="">Seleccionar kit</option>
                    {% for kit in kits %}
                        <option value="{{ kit.id }}">{{ kit.sku }} - {{ kit.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="full">
                <label for="kit-edit-name">Nombre</label>
                <input id="kit-edit-name" name="kit_name">
            </div>
            <div>
                <label for="kit-edit-sku">SKU (opcional)</label>
                <input id="kit-edit-sku" name="kit_sku">
            </div>
            <div>
                <label for="kit-edit-group">Marca / Grupo</label>
                <input id="kit-edit-group" name="kit_group" list="group-options">
            </div>
            <div>
                <label for="kit-edit-price-dist">Precio distribuidor (fijo)</label>
                <input id="kit-edit-price-dist" name="kit_price_distributor" placeholder="0,00">
            </div>
            <div>
                <label for="kit-edit-margin-barber">Margen barberías %</label>
                <input id="kit-edit-margin-barber" name="kit_margin_barber" placeholder="0,00">
            </div>
            <div>
                <label for="kit-edit-margin-consumer">Margen consumidor %</label>
                <input id="kit-edit-margin-consumer" name="kit_margin_consumer" placeholder="0,00">
            </div>
        </div>
        <div id="kit-edit-items"></div>
        <button type="button" id="kit-edit-add-item">Agregar producto al kit</button>
        <button type="submit">Guardar cambios</button>
    </form>
</div>

{{ kit_data|json_script:"kit-data" }}
<div class="card table-card">
    <div class="card-title">Precios por producto</div>
    <div class="price-filter">
        <span class="hint">Buscar</span>
        <input id="price-search" type="text" placeholder="SKU, producto o marca" list="price-options">
        <datalist id="price-options">
            {% for product in products %}
            <option value="{{ product.sku }}"></option>
            <option value="{{ product.name }}"></option>
            {% if product.group %}
            <option value="{{ product.group }}"></option>
            {% endif %}
            {% endfor %}
        </datalist>
    </div>
    <table>
        <thead>
            <tr>
                <th>SKU</th>
                <th>Producto</th>
                <th>Marca</th>
                <th>Consumidor final</th>
                <th>Peluquerías / Barberías</th>
                <th>Distribuidores</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.sku }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.group|default:"-" }}</td>
                <td>
                    <form id="price-form-{{ product.id }}" method="post" action="{% url 'inventory_product_prices' %}">
                        {% csrf_token %}
                    </form>
                    <input form="price-form-{{ product.id }}" type="hidden" name="action" value="update_prices">
                    <input form="price-form-{{ product.id }}" type="hidden" name="product_id" value="{{ product.id }}">
                    <input form="price-form-{{ product.id }}" class="price-input" name="price_consumer" value="{% if product.price_consumer and product.price_consumer > 0 %}{{ product.price_consumer|latam_number:2 }}{% endif %}" placeholder="{{ product.consumer_price|latam_number:2 }}">
                </td>
                <td>
                    <input form="price-form-{{ product.id }}" class="price-input" name="price_barber" value="{% if product.price_barber and product.price_barber > 0 %}{{ product.price_barber|latam_number:2 }}{% endif %}" placeholder="{{ product.barber_price|latam_number:2 }}">
                </td>
                <td>
                    <input form="price-form-{{ product.id }}" class="price-input" name="price_distributor" value="{% if product.price_distributor and product.price_distributor > 0 %}{{ product.price_distributor|latam_number:2 }}{% endif %}" placeholder="{{ product.distributor_price|latam_number:2 }}">
                </td>
                <td>
                    <button form="price-form-{{ product.id }}" type="submit" class="pill sm" style="font-size:12px; padding:4px 8px;">Guardar</button>
                    <a class="pill sm" style="font-size:12px; padding:4px 8px;" href="{% url 'inventory_edit_product' product.pk %}">Editar</a>
                    <form method="post" action="{% url 'inventory_product_delete' product.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="pill sm" style="font-size:12px; padding:4px 8px;" onclick="return confirm('¿Eliminar este producto?');">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6">Aún no hay productos cargados.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    (function() {
        const filterInput = document.getElementById("price-search");
        const downloadLinks = Array.from(document.querySelectorAll(".price-download"));
        if (!filterInput) return;
        const rows = Array.from(document.querySelectorAll("table tbody tr"));
        const getRowText = (row) => {
            const sku = row.children[0]?.textContent || "";
            const name = row.children[1]?.textContent || "";
            const brand = row.children[2]?.textContent || "";
            return `${sku} ${name} ${brand}`.toLowerCase();
        };
        const getRowBrand = (row) => (row.children[2]?.textContent || "").trim();
        const brands = Array.from(new Set(rows.map(getRowBrand).filter(Boolean)));
        const applyFilter = () => {
            const query = filterInput.value.trim().toLowerCase();
            rows.forEach((row) => {
                if (!row.querySelector("td")) return;
                const matchesText = !query || getRowText(row).includes(query);
                row.style.display = matchesText ? "" : "none";
            });
        };
        filterInput.addEventListener("input", applyFilter);

        const updateDownloads = () => {
            const query = filterInput.value.trim();
            const matchedBrand = brands.find((brand) => brand.toLowerCase() === query.toLowerCase());
            downloadLinks.forEach((link) => {
                const base = link.getAttribute("data-base-href");
                if (!base) return;
                link.href = matchedBrand ? `${base}?groups=${encodeURIComponent(matchedBrand)}` : base;
            });
        };
        filterInput.addEventListener("change", updateDownloads);
        filterInput.addEventListener("blur", updateDownloads);
        updateDownloads();
    })();

    (function() {
        const products = [
            {% for product in products_no_kits %}
            { id: "{{ product.id }}", label: "{{ product.sku }} - {{ product.name }}" },
            {% endfor %}
        ];
        const kitDataNode = document.getElementById("kit-data");
        const kitData = kitDataNode ? JSON.parse(kitDataNode.textContent) : [];
        const kitMap = {};
        kitData.forEach((kit) => {
            kitMap[String(kit.id)] = kit;
        });
        const renderRow = (container, prefix = "") => {
            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.gap = "8px";
            row.style.marginTop = "8px";
            const select = document.createElement("select");
            select.name = `${prefix}kit_component`;
            const empty = document.createElement("option");
            empty.value = "";
            empty.textContent = "Producto";
            select.appendChild(empty);
            products.forEach((prod) => {
                const opt = document.createElement("option");
                opt.value = prod.id;
                opt.textContent = prod.label;
                select.appendChild(opt);
            });
            const qty = document.createElement("input");
            qty.name = `${prefix}kit_quantity`;
            qty.placeholder = "Cantidad";
            const remove = document.createElement("button");
            remove.type = "button";
            remove.textContent = "Quitar";
            remove.addEventListener("click", () => row.remove());
            row.appendChild(select);
            row.appendChild(qty);
            row.appendChild(remove);
            container.appendChild(row);
            return { select, qty, row };
        };

        const kitItems = document.getElementById("kit-items");
        const kitAdd = document.getElementById("kit-add-item");
        if (kitItems && kitAdd) {
            kitAdd.addEventListener("click", () => renderRow(kitItems, ""));
            renderRow(kitItems, "");
            renderRow(kitItems, "");
        }

        const kitEditItems = document.getElementById("kit-edit-items");
        const kitEditAdd = document.getElementById("kit-edit-add-item");
        if (kitEditItems && kitEditAdd) {
            kitEditAdd.addEventListener("click", () => renderRow(kitEditItems, ""));
        }

        const kitEditSelect = document.getElementById("kit-edit-id");
        const kitEditName = document.getElementById("kit-edit-name");
        const kitEditSku = document.getElementById("kit-edit-sku");
        const kitEditGroup = document.getElementById("kit-edit-group");
        const kitEditPrice = document.getElementById("kit-edit-price-dist");
        const kitEditMarginBarber = document.getElementById("kit-edit-margin-barber");
        const kitEditMarginConsumer = document.getElementById("kit-edit-margin-consumer");
        if (kitEditSelect) {
            kitEditSelect.addEventListener("change", () => {
                const kit = kitMap[kitEditSelect.value];
                if (!kit) return;
                if (kitEditName) kitEditName.value = kit.name || "";
                if (kitEditSku) kitEditSku.value = kit.sku || "";
                if (kitEditGroup) kitEditGroup.value = kit.group || "";
                if (kitEditPrice) kitEditPrice.value = kit.price_distributor || "";
                if (kitEditMarginBarber) kitEditMarginBarber.value = kit.margin_barber || "";
                if (kitEditMarginConsumer) kitEditMarginConsumer.value = kit.margin_consumer || "";
                if (kitEditItems) {
                    kitEditItems.innerHTML = "";
                    (kit.components || []).forEach((comp) => {
                        const row = renderRow(kitEditItems, "");
                        row.select.value = String(comp.product_id || "");
                        row.qty.value = comp.quantity || "";
                    });
                }
            });
        }
    })();
</script>
{% endblock %}
