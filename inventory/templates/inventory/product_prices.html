{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Lista de precios{% endblock %}
{% block content %}
<h1>Lista de precios</h1>
<p class="subtitle">Precios diferenciados por canal.</p>
<style>
    .price-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #0f1622;
        border: 1px solid #2a313c;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        margin: 8px 0 12px;
    }
    .price-filter input {
        background: transparent;
        border: none;
        color: var(--text);
        width: 100%;
        padding: 4px 2px;
        font-size: 14px;
    }
    .price-filter input:focus { outline: none; }
    .price-filter .hint {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.3px;
        text-transform: uppercase;
        white-space: nowrap;
    }
</style>

<div class="actions" style="margin-bottom:16px;">
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'consumer' %}" href="{% url 'inventory_product_prices_download' 'consumer' %}">Descargar consumidor final</a>
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'barber' %}" href="{% url 'inventory_product_prices_download' 'barber' %}">Descargar peluquerías/barberías</a>
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'distributor' %}" href="{% url 'inventory_product_prices_download' 'distributor' %}">Descargar distribuidores</a>
</div>

<div class="card table-card">
    <div class="card-title">Precios por producto</div>
    <div class="price-filter">
        <span class="hint">Buscar</span>
        <input id="price-filter" type="text" placeholder="SKU o producto">
    </div>
    <div class="price-filter" style="flex-direction:column; align-items:stretch;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span class="hint">Marcas</span>
            <input id="brand-search" type="text" placeholder="Buscar marca..." style="flex:1;">
        </div>
        <select id="price-groups" multiple style="width:100%; background:transparent; border:none; color:var(--text); height:120px;">
            {% for group in group_options %}
            <option value="{{ group }}">{{ group }}</option>
            {% endfor %}
        </select>
    </div>
    <table>
        <thead>
            <tr>
                <th>SKU</th>
                <th>Producto</th>
                <th>Marca</th>
                <th>Consumidor final</th>
                <th>Peluquerías / Barberías</th>
                <th>Distribuidores</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.sku }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.group|default:"-" }}</td>
                <td>{{ product.consumer_price|latam_number:2 }}</td>
                <td>{{ product.barber_price|latam_number:2 }}</td>
                <td>{{ product.distributor_price|latam_number:2 }}</td>
                <td>
                    <a class="pill" href="{% url 'inventory_edit_product' product.pk %}">Editar</a>
                    <form method="post" action="{% url 'inventory_product_delete' product.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('¿Eliminar este producto?');">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6">Aún no hay productos cargados.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    (function() {
        const filterInput = document.getElementById("price-filter");
        const groupSelect = document.getElementById("price-groups");
        const brandSearch = document.getElementById("brand-search");
        const downloadLinks = Array.from(document.querySelectorAll(".price-download"));
        if (!filterInput) return;
        const rows = Array.from(document.querySelectorAll("table tbody tr"));
        const getRowText = (row) => {
            const sku = row.children[0]?.textContent || "";
            const name = row.children[1]?.textContent || "";
            const brand = row.children[2]?.textContent || "";
            return `${sku} ${name} ${brand}`.toLowerCase();
        };
        const getRowBrand = (row) => (row.children[2]?.textContent || "").trim();
        const applyFilter = () => {
            const query = filterInput.value.trim().toLowerCase();
            const selectedBrands = groupSelect
                ? Array.from(groupSelect.selectedOptions).map(opt => opt.value)
                : [];
            rows.forEach((row) => {
                if (!row.querySelector("td")) return;
                const matchesText = !query || getRowText(row).includes(query);
                const rowBrand = getRowBrand(row);
                const matchesBrand = !selectedBrands.length || selectedBrands.includes(rowBrand);
                row.style.display = matchesText && matchesBrand ? "" : "none";
            });
        };
        filterInput.addEventListener("input", applyFilter);

        const updateDownloads = () => {
            if (!groupSelect) return;
            const selected = Array.from(groupSelect.selectedOptions).map(opt => opt.value);
            const groups = selected.join(",");
            downloadLinks.forEach((link) => {
                const base = link.getAttribute("data-base-href");
                if (!base) return;
                link.href = groups ? `${base}?groups=${encodeURIComponent(groups)}` : base;
            });
        };
        if (groupSelect) {
            groupSelect.addEventListener("change", () => {
                updateDownloads();
                applyFilter();
            });
            updateDownloads();
        }

        if (brandSearch && groupSelect) {
            brandSearch.addEventListener("input", () => {
                const query = brandSearch.value.trim().toLowerCase();
                Array.from(groupSelect.options).forEach((opt) => {
                    opt.hidden = query && !opt.value.toLowerCase().includes(query);
                });
            });
        }
    })();
</script>
{% endblock %}
