{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Lista de precios{% endblock %}
{% block content %}
<h1>Lista de precios</h1>
<p class="subtitle">Precios diferenciados por canal.</p>
<style>
    .price-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #0f1622;
        border: 1px solid #2a313c;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        margin: 8px 0 12px;
    }
    .price-filter input {
        background: transparent;
        border: none;
        color: var(--text);
        width: 100%;
        padding: 4px 2px;
        font-size: 14px;
    }
    .price-filter input:focus { outline: none; }
    .price-filter .hint {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.3px;
        text-transform: uppercase;
        white-space: nowrap;
    }
</style>

<div class="actions" style="margin-bottom:16px;">
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'consumer' %}" href="{% url 'inventory_product_prices_download' 'consumer' %}">Descargar consumidor final</a>
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'barber' %}" href="{% url 'inventory_product_prices_download' 'barber' %}">Descargar peluquerías/barberías</a>
    <a class="pill price-download" data-base-href="{% url 'inventory_product_prices_download' 'distributor' %}" href="{% url 'inventory_product_prices_download' 'distributor' %}">Descargar distribuidores</a>
</div>

<div class="card table-card">
    <div class="card-title">Precios por producto</div>
    <div class="price-filter">
        <span class="hint">Buscar</span>
        <input id="price-search" type="text" placeholder="SKU, producto o marca" list="price-options">
        <datalist id="price-options">
            {% for product in products %}
            <option value="{{ product.sku }}"></option>
            <option value="{{ product.name }}"></option>
            {% if product.group %}
            <option value="{{ product.group }}"></option>
            {% endif %}
            {% endfor %}
        </datalist>
    </div>
    <table>
        <thead>
            <tr>
                <th>SKU</th>
                <th>Producto</th>
                <th>Marca</th>
                <th>Consumidor final</th>
                <th>Peluquerías / Barberías</th>
                <th>Distribuidores</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.sku }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.group|default:"-" }}</td>
                <td>
                    <form method="post" action="{% url 'inventory_product_prices' %}" style="display:flex; gap:6px; align-items:center;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_consumer_price">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input name="price_consumer" value="{% if product.price_consumer and product.price_consumer > 0 %}{{ product.price_consumer|latam_number:2 }}{% endif %}" placeholder="{{ product.consumer_price|latam_number:2 }}" style="max-width:120px;">
                        <button type="submit">Guardar</button>
                    </form>
                </td>
                <td>{{ product.barber_price|latam_number:2 }}</td>
                <td>{{ product.distributor_price|latam_number:2 }}</td>
                <td>
                    <a class="pill" href="{% url 'inventory_edit_product' product.pk %}">Editar</a>
                    <form method="post" action="{% url 'inventory_product_delete' product.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('¿Eliminar este producto?');">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6">Aún no hay productos cargados.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    (function() {
        const filterInput = document.getElementById("price-search");
        const downloadLinks = Array.from(document.querySelectorAll(".price-download"));
        if (!filterInput) return;
        const rows = Array.from(document.querySelectorAll("table tbody tr"));
        const getRowText = (row) => {
            const sku = row.children[0]?.textContent || "";
            const name = row.children[1]?.textContent || "";
            const brand = row.children[2]?.textContent || "";
            return `${sku} ${name} ${brand}`.toLowerCase();
        };
        const getRowBrand = (row) => (row.children[2]?.textContent || "").trim();
        const brands = Array.from(new Set(rows.map(getRowBrand).filter(Boolean)));
        const applyFilter = () => {
            const query = filterInput.value.trim().toLowerCase();
            rows.forEach((row) => {
                if (!row.querySelector("td")) return;
                const matchesText = !query || getRowText(row).includes(query);
                row.style.display = matchesText ? "" : "none";
            });
        };
        filterInput.addEventListener("input", applyFilter);

        const updateDownloads = () => {
            const query = filterInput.value.trim();
            const matchedBrand = brands.find((brand) => brand.toLowerCase() === query.toLowerCase());
            downloadLinks.forEach((link) => {
                const base = link.getAttribute("data-base-href");
                if (!base) return;
                link.href = matchedBrand ? `${base}?groups=${encodeURIComponent(matchedBrand)}` : base;
            });
        };
        filterInput.addEventListener("change", updateDownloads);
        filterInput.addEventListener("blur", updateDownloads);
        updateDownloads();
    })();
</script>
{% endblock %}
