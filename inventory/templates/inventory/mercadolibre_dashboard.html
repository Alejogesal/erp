{% extends "inventory/base.html" %}
{% block title %}MercadoLibre{% endblock %}
{% block content %}
<h1>MercadoLibre</h1>
<p class="subtitle">Conexión, stock y ventas sincronizadas con el depósito MERCADOLIBRE.</p>

<div class="cards">
    <div class="card">
        <div class="card-title">Estado de conexión</div>
        {% if missing_credentials %}
            <p style="color: var(--negative);">Faltan credenciales ML en el servidor.</p>
        {% endif %}
        {% if connection and connection.access_token %}
            <p><strong>Conectado:</strong> {{ connection.nickname|default:"Cuenta ML" }}</p>
            {% if connection.ml_user_id %}
            <p><strong>User ID:</strong> {{ connection.ml_user_id }}</p>
            {% endif %}
            {% if connection.last_sync_at %}
            <p><strong>Último sync:</strong> {{ connection.last_sync_at }}</p>
            {% endif %}
        {% else %}
            <p>Cuenta no conectada.</p>
        {% endif %}
        <div style="margin-top:10px;">
            {% if connection and connection.access_token %}
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="sync">
                    <button type="submit">Sincronizar ahora</button>
                </form>
            {% else %}
                {% if missing_credentials %}
                    <button type="button" disabled style="opacity:0.6;">Conectar MercadoLibre</button>
                {% else %}
                    <a class="pill" href="{% url 'inventory_mercadolibre_connect' %}">Conectar MercadoLibre</a>
                {% endif %}
            {% endif %}
        </div>
    </div>
<div class="card">
    <div class="card-title">Métricas (últimos {{ metrics.window_days|default:"30" }} días)</div>
    {% if metrics.orders %}
            <p><strong>Órdenes (muestra):</strong> {{ metrics.orders_sampled|default:metrics.orders }}</p>
            {% if metrics.orders_total and metrics.orders_total != metrics.orders_sampled %}
            <p><strong>Órdenes totales ML:</strong> {{ metrics.orders_total }}</p>
            {% endif %}
            <p><strong>Unidades vendidas:</strong> {{ metrics.items_sold }}</p>
            <p><strong>Monto total:</strong> ${{ metrics.total_amount }}</p>
            <p style="color: var(--muted); font-size: 12px; margin-top: 8px;">
                Las métricas se calculan sobre la muestra sincronizada del período.
            </p>
    {% else %}
            <p>Sin métricas disponibles. Ejecutá un sync.</p>
    {% endif %}
</div>
</div>

<div class="card table-card">
    <div class="card-title">Publicaciones</div>
    <style>
        .ml-item-link {
            color: var(--text);
            text-decoration: none;
        }
        .ml-match-field {
            display: grid;
            gap: 6px;
            padding: 6px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(16, 22, 32, 0.9), rgba(12, 18, 27, 0.95));
            border: 1px solid #2a313c;
        }
        .ml-match-search,
        .ml-match-select {
            position: relative;
            border-radius: 8px;
            background: #0b111a;
            border: 1px solid #1e2733;
        }
        .ml-match-search input,
        .ml-match-select select {
            width: 100%;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 13px;
            padding: 8px 10px 8px 28px;
        }
        .ml-match-search::before {
            content: "⌕";
            position: absolute;
            left: 9px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 12px;
            pointer-events: none;
        }
        .ml-match-search input:focus,
        .ml-match-select select:focus { outline: none; }
        .ml-match-select select {
            appearance: none;
            padding-left: 10px;
            padding-right: 28px;
        }
        .ml-match-select::after {
            content: "▾";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            pointer-events: none;
        }
    </style>
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin: 8px 0 12px;">
        <div>
            <label for="ml-status-filter" style="font-size: 12px; color: var(--muted); display:block; margin-bottom:4px;">
                Estado
            </label>
            <select id="ml-status-filter">
                <option value="all">Todas</option>
                <option value="active">Activas</option>
                <option value="paused">Pausadas</option>
            </select>
        </div>
        <div>
            <label for="ml-sales-filter" style="font-size: 12px; color: var(--muted); display:block; margin-bottom:4px;">
                Ventas
            </label>
            <select id="ml-sales-filter">
                <option value="all">Todas</option>
                <option value="recent">Con ventas recientes</option>
                <option value="none">Sin ventas recientes</option>
            </select>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Item</th>
                <th>Producto (match)</th>
                <th>Stock ML</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr data-status="{{ item.status }}" data-recent="{% if item.last_sold_at and item.last_sold_at >= recent_cutoff %}1{% else %}0{% endif %}">
                <td>
                    {% if item.permalink %}
                    <a class="ml-item-link" href="{{ item.permalink }}" target="_blank" rel="noreferrer">
                        {{ item.title }}
                    </a>
                    {% else %}
                    {{ item.title }}
                    {% endif %}
                </td>
                <td>
                    {% if item.product %}
                        <div style="font-weight: 600;">
                            {{ item.product.name }}{% if item.product.group %} ({{ item.product.group }}){% endif %}
                        </div>
                    {% else %}
                        <div style="color: var(--muted);">Sin match</div>
                    {% endif %}
                    <form method="post" style="margin-top:6px;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="link_item">
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <div class="ml-match-field">
                            <div class="ml-match-search">
                                <input type="text" class="ml-product-search" placeholder="Buscar producto...">
                            </div>
                            <div class="ml-match-select">
                                <select name="product_id">
                                    <option value="">-- Sin match --</option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}"{% if item.product and product.id == item.product.id %} selected{% endif %}>
                                        {{ product.name }}{% if product.group %} ({{ product.group }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <button type="submit" style="margin-top:6px;">Guardar</button>
                    </form>
                </td>
                <td>{{ item.available_quantity }}</td>
                <td>{{ item.status }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">Aún no hay publicaciones sincronizadas.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    (function() {
        const statusFilter = document.getElementById("ml-status-filter");
        const salesFilter = document.getElementById("ml-sales-filter");
        const rows = Array.from(document.querySelectorAll("table tbody tr"));
        const applyFilters = () => {
            const status = statusFilter?.value || "all";
            const sales = salesFilter?.value || "all";
            rows.forEach((row) => {
                const rowStatus = row.getAttribute("data-status") || "";
                const recent = row.getAttribute("data-recent") || "0";
                const statusOk = status === "all" || rowStatus === status;
                const salesOk =
                    sales === "all" ||
                    (sales === "recent" && recent === "1") ||
                    (sales === "none" && recent === "0");
                row.style.display = statusOk && salesOk ? "" : "none";
            });
        };
        statusFilter?.addEventListener("change", applyFilters);
        salesFilter?.addEventListener("change", applyFilters);
    })();
</script>
<script>
    (function() {
        document.querySelectorAll(".ml-product-search").forEach((input) => {
            const field = input.closest(".ml-match-field");
            const select = field ? field.querySelector("select") : null;
            if (!select) {
                return;
            }
            const options = Array.from(select.options);
            input.addEventListener("input", () => {
                const query = input.value.trim().toLowerCase();
                options.forEach((opt) => {
                    if (!opt.value) {
                        opt.hidden = false;
                        return;
                    }
                    const text = opt.textContent.toLowerCase();
                    opt.hidden = query && !text.includes(query);
                });
                if (query) {
                    const visibleOption = options.find((opt) => !opt.hidden && opt.value);
                    if (visibleOption) {
                        select.value = visibleOption.value;
                    }
                }
            });
        });
    })();
</script>
{% endblock %}
