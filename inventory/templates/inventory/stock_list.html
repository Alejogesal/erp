{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Stock{% endblock %}
{% block content %}
<h1>Stock</h1>
<p class="subtitle">Listado de productos por depósito.</p>
<style>
    .stock-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #0f1622;
        border: 1px solid #2a313c;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        margin-bottom: 12px;
    }
    .stock-filter input {
        background: transparent;
        border: none;
        color: var(--text);
        width: 100%;
        padding: 4px 2px;
        font-size: 14px;
    }
    .stock-filter input:focus { outline: none; }
    .stock-filter .hint {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.3px;
        text-transform: uppercase;
        white-space: nowrap;
    }
    .stock-adjust {
        display: grid;
        gap: 6px;
        min-width: 160px;
    }
    .stock-adjust input {
        width: 100%;
    }
    .ml-product-input {
        margin-bottom: 0;
    }
    .ml-product-select {
        display: none;
    }
    .ml-product-wrap {
        position: relative;
    }
    .ml-product-results {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        right: 0;
        max-height: 240px;
        overflow-y: auto;
        background: #0f1622;
        border: 1px solid #2a313c;
        border-radius: 10px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
        z-index: 5;
        display: none;
    }
    .ml-product-results button {
        width: 100%;
        text-align: left;
        background: transparent;
        color: var(--text);
        padding: 8px 10px;
        border-radius: 8px;
        font-weight: 500;
    }
    .ml-product-results button:hover {
        background: rgba(47, 129, 247, 0.12);
    }
</style>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Transferir a MercadoLibre</div>
    {% if can_transfer %}
    <form method="post">
        {% csrf_token %}
        <div class="cards" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                {{ transfer_form.product.label_tag }}
                <div class="ml-product-wrap">
                    <input id="ml-product-input" class="ml-product-input" type="text" placeholder="Buscar por coincidencias">
                    <div id="ml-product-results" class="ml-product-results"></div>
                </div>
                {{ transfer_form.product }}
            </div>
            <div>
                {{ transfer_form.quantity.label_tag }}
                {{ transfer_form.quantity }}
            </div>
            <div style="grid-column: 1 / -1;">
                {{ transfer_form.bulk_list.label_tag }}
                {{ transfer_form.bulk_list }}
                <div style="color: var(--muted); font-size: 12px; margin-top: 4px;">
                    Formato sugerido: SKU; cantidad (una por línea). Ej: ABC123; 10
                </div>
            </div>
        </div>
        <div style="margin-top:12px;">
            <button type="submit">Transferir</button>
        </div>
    </form>
    <form method="post" style="margin-top:12px;" onsubmit="return confirm('¿Crear compras a partir del stock actual de MercadoLibre?');">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_ml_purchase">
        <button type="submit">Crear compras desde stock ML</button>
    </form>
    {% else %}
    <div>Configurá los depósitos Común y MercadoLibre para habilitar transferencias.</div>
    {% endif %}
</div>

<div class="card table-card">
    <div class="card-title">Stock por depósito</div>
    <div class="stock-filter">
        <span class="hint">Buscar</span>
        <input id="stock-filter" type="text" placeholder="SKU, producto o marca" value="{{ query }}">
    </div>
    <table>
        <thead>
            <tr>
                <th>SKU</th>
                <th>Producto</th>
                <th>Comun</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.sku }}</td>
                <td>
                    {{ product.name }}
                    <div style="margin-top:6px; font-size:12px;">
                        <a href="{% url 'inventory_product_variants' product.id %}" style="color: var(--muted);">
                            Variedades
                        </a>
                    </div>
                </td>
                <td>
                    {% if product.has_variants %}
                        <div style="color: var(--muted); font-size: 12px;">
                            Variedades: {{ product.comun_qty|latam_number:2 }}
                        </div>
                    {% else %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="set_comun_stock">
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <div class="stock-adjust">
                                <div style="color: var(--muted); font-size: 12px;">
                                    Actual: {{ product.comun_qty|latam_number:2 }}
                                </div>
                                <input name="quantity" type="text" value="{{ product.comun_qty|latam_number:2 }}">
                                <button type="submit">Actualizar</button>
                            </div>
                        </form>
                    {% endif %}
                </td>
                <td>{{ product.total_qty|latam_number:2 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">Aún no hay stock registrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    (function() {
        const filterInput = document.getElementById("stock-filter");
        if (!filterInput) return;
        const rows = Array.from(document.querySelectorAll("table tbody tr"));
        const getRowText = (row) => {
            const sku = row.children[0]?.textContent || "";
            const name = row.children[1]?.textContent || "";
            return `${sku} ${name}`.toLowerCase();
        };
        const applyFilter = () => {
            const query = filterInput.value.trim().toLowerCase();
            rows.forEach((row) => {
                if (!row.querySelector("td")) return;
                row.style.display = !query || getRowText(row).includes(query) ? "" : "none";
            });
        };
        filterInput.addEventListener("input", applyFilter);
    })();
</script>
<script>
    (function() {
        const productSelect = document.querySelector("select[name='product']");
        const productInput = document.getElementById("ml-product-input");
        const results = document.getElementById("ml-product-results");
        if (!productSelect || !productInput || !results) return;

        productSelect.classList.add("ml-product-select");

        const options = Array.from(productSelect.options).filter((option) => option.value);
        const optionData = options.map((option) => ({
            value: option.value,
            label: option.textContent || "",
            labelLower: (option.textContent || "").toLowerCase(),
        }));

        const renderResults = () => {
            const query = productInput.value.trim().toLowerCase();
            if (!query) {
                results.style.display = "none";
                results.innerHTML = "";
                return;
            }
            const matches = optionData.filter((item) => item.labelLower.includes(query)).slice(0, 30);
            if (!matches.length) {
                results.style.display = "none";
                results.innerHTML = "";
                return;
            }
            results.innerHTML = matches
                .map((item) => `<button type="button" data-value="${item.value}">${item.label}</button>`)
                .join("");
            results.style.display = "block";
        };

        productInput.addEventListener("input", renderResults);
        productInput.addEventListener("focus", () => {
            if (productInput.value.trim() === "-----") {
                productInput.value = "";
            }
            renderResults();
        });
        document.addEventListener("click", (event) => {
            if (!results.contains(event.target) && event.target !== productInput) {
                results.style.display = "none";
            }
        });
        results.addEventListener("click", (event) => {
            const target = event.target;
            if (target.tagName !== "BUTTON") return;
            const value = target.getAttribute("data-value");
            const match = optionData.find((item) => item.value === value);
            if (match) {
                productInput.value = match.label;
                productSelect.value = match.value;
            }
            results.style.display = "none";
        });

        productInput.value = "";
    })();
</script>
{% endblock %}
