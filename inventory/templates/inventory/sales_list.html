{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Ventas{% endblock %}
{% block content %}
<h1>Ventas</h1>
<p class="subtitle">Registrá ventas y consultá comprobantes emitidos.</p>
<style>
    .delivery-status-select {
        background: var(--status-bg, #0f1622);
        color: var(--status-color, var(--text));
    }
</style>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Importar ventas MercadoLibre (Excel)</div>
    <form method="post" action="{% url 'inventory_sales_list' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="import_ml_sales_xlsx">
        <p style="color: var(--muted); margin: 0 0 10px;">
            Columnas requeridas: Fecha, Producto, Cantidad, Precio Bruto Venta, Comision, Impuestos.
        </p>
        <input type="file" name="file" accept=".xlsx" required>
        <button type="submit" style="margin-top:10px;">Importar ventas</button>
    </form>
</div>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Registrar venta</div>
    <form method="post" action="{% url 'inventory_sales_list' %}" data-clear-form="{% if clear_sale_form %}1{% else %}0{% endif %}" data-default-warehouse="{{ default_warehouse_id }}">
        {% csrf_token %}
        <h3>Datos de la venta</h3>
        {{ form.as_p }}
        {{ formset.non_form_errors }}
        <h3>Productos</h3>
        {{ formset.management_form }}
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Variedad</th>
                    <th>Cantidad</th>
                    <th>DTO %</th>
                    <th>IVA %</th>
                </tr>
            </thead>
            <tbody id="items-body">
                {% for item_form in formset.forms %}
                <tr>
                    <td>{{ item_form.product }}</td>
                    <td>
                        <select name="{{ item_form.prefix }}-variant_id" class="variant-select" data-selected=""></select>
                    </td>
                    <td>{{ item_form.quantity }}</td>
                    <td>{{ item_form.discount_percent }}</td>
                    <td>{{ item_form.vat_percent }}</td>
                </tr>
                {% if item_form.errors %}
                <tr>
                    <td colspan="6">{{ item_form.errors }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="add-item">Agregar producto</button>
        <button type="submit">Registrar venta</button>
    </form>
</div>

<div class="card table-card">
    <div class="card-title" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <span>Historial de ventas</span>
        <div style="font-size:12px; color:var(--muted); display:flex; align-items:center; gap:10px;">
            <label>Desde <input id="bulk-select-start" name="start_date" type="date" value="{{ start_date }}" style="margin-left:6px;"></label>
            <label>Hasta <input id="bulk-select-end" name="end_date" type="date" value="{{ end_date }}" style="margin-left:6px;"></label>
        </div>
    </div>
    <div style="display:flex; justify-content:flex-end; margin:6px 0 0;">
        <button type="button" id="history-load" class="pill" style="font-size:12px; padding:4px 8px; {% if show_history %}display:none;{% endif %}">
            Cargar historial
        </button>
    </div>
    <form method="get" id="history-filter" style="margin:10px 0 12px;">
        <div class="cards" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                <label for="q">Buscar</label>
                <input id="q" name="q" type="text" value="{{ search_query }}" placeholder="Cliente o producto">
            </div>
            <div style="display:flex; align-items:center; gap:12px; padding-top:22px;">
                <label style="display:flex; gap:6px; align-items:center;">
                    <input type="checkbox" name="wh_comun" value="1" {% if include_comun %}checked{% endif %}>
                    Depósito Común
                </label>
                <label style="display:flex; gap:6px; align-items:center;">
                    <input type="checkbox" name="wh_ml" value="1" {% if include_ml %}checked{% endif %}>
                    MercadoLibre
                </label>
            </div>
        </div>
    </form>
    <form method="post" action="{% url 'inventory_sales_list' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="bulk_delete_selected">
        <div style="display:flex; justify-content:flex-end; margin:6px 0 10px;">
            <div style="display:flex; flex-direction:column; align-items:flex-start; gap:6px;">
                <button type="button" id="bulk-select-all" class="pill" style="font-size:12px; padding:4px 8px;">Seleccionar todas</button>
                <button type="submit" class="pill" onclick="return confirm('¿Eliminar ventas seleccionadas?');" style="font-size:12px; padding:4px 8px;">Eliminar seleccionadas</button>
            </div>
        </div>
        <div id="sales-history" data-loaded="{% if show_history %}1{% else %}0{% endif %}">
            {% include "inventory/_sales_history.html" %}
        </div>
    </form>
</div>
{{ customer_audiences|json_script:"customer-audiences" }}
{{ variant_data|json_script:"sale-variant-data" }}
<script>
    (function() {
        const form = document.getElementById("history-filter");
        const queryInput = document.getElementById("q");
        const historyEl = document.getElementById("sales-history");
        const whComun = form ? form.querySelector("input[name='wh_comun']") : null;
        const whMl = form ? form.querySelector("input[name='wh_ml']") : null;
        const startInput = document.getElementById("bulk-select-start");
        const endInput = document.getElementById("bulk-select-end");
        const loadBtn = document.getElementById("history-load");
        let historyEnabled = historyEl?.dataset.loaded === "1";
        let debounceId = null;
        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
            return "";
        };

        const buildParams = (page) => {
            const params = new URLSearchParams();
            if (queryInput?.value) params.set("q", queryInput.value);
            if (whComun?.checked) params.set("wh_comun", "1");
            if (whMl?.checked) params.set("wh_ml", "1");
            if (startInput?.value) params.set("start_date", startInput.value);
            if (endInput?.value) params.set("end_date", endInput.value);
            if (page) params.set("page", String(page));
            if (historyEnabled) params.set("show_history", "1");
            params.set("ajax", "1");
            return params;
        };

        const updateUrl = (page) => {
            const params = new URLSearchParams();
            if (queryInput?.value) params.set("q", queryInput.value);
            if (whComun?.checked) params.set("wh_comun", "1");
            if (whMl?.checked) params.set("wh_ml", "1");
            if (startInput?.value) params.set("start_date", startInput.value);
            if (endInput?.value) params.set("end_date", endInput.value);
            if (page) params.set("page", String(page));
            if (historyEnabled) params.set("show_history", "1");
            const qs = params.toString();
            const url = qs ? `${location.pathname}?${qs}#history` : `${location.pathname}#history`;
            history.replaceState(null, "", url);
        };

        const fetchHistory = (page) => {
            if (!historyEl) return;
            const params = buildParams(page);
            fetch(`${location.pathname}?${params.toString()}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
                .then((resp) => resp.json())
                .then((data) => {
                    if (!data?.html) return;
                    historyEl.innerHTML = data.html;
                    updateUrl(page || 1);
                    initBulkSelect();
                })
                .catch(() => {});
        };

        if (form) {
            form.addEventListener("submit", (event) => event.preventDefault());
        }
        if (queryInput) {
            queryInput.addEventListener("input", () => {
                if (!historyEnabled) return;
                if (debounceId) clearTimeout(debounceId);
                debounceId = setTimeout(() => fetchHistory(1), 250);
            });
        }
        [whComun, whMl].forEach((checkbox) => {
            if (checkbox) checkbox.addEventListener("change", () => {
                if (!historyEnabled) return;
                fetchHistory(1);
            });
        });
        [startInput, endInput].forEach((input) => {
            if (input) input.addEventListener("change", () => {
                if (!historyEnabled) return;
                fetchHistory(1);
            });
        });
        historyEl?.addEventListener("click", (event) => {
            const target = event.target;
            if (!(target instanceof HTMLAnchorElement)) return;
            if (!target.classList.contains("history-page-link")) return;
            if (!historyEnabled) return;
            event.preventDefault();
            const url = new URL(target.href);
            const page = url.searchParams.get("page") || "1";
            fetchHistory(page);
        });
        loadBtn?.addEventListener("click", () => {
            historyEnabled = true;
            fetchHistory(1);
        });

        const syncDeliverySelectStyle = (selectEl) => {
            if (!selectEl) return;
            const option = selectEl.selectedOptions?.[0];
            if (!option) return;
            const bg = option.dataset.bg || "";
            const color = option.dataset.color || "";
            selectEl.style.setProperty("--status-bg", bg);
            selectEl.style.setProperty("--status-color", color);
        };

        historyEl?.querySelectorAll(".delivery-status-select").forEach((selectEl) => {
            syncDeliverySelectStyle(selectEl);
        });

        historyEl?.addEventListener("change", async (event) => {
            const target = event.target;
            if (!(target instanceof HTMLSelectElement)) return;
            if (!target.classList.contains("delivery-status-select")) return;
            const updateUrl = target.dataset.updateUrl;
            if (!updateUrl) return;
            const previous = target.dataset.current || "";
            const next = target.value;
            if (next === previous) return;
            syncDeliverySelectStyle(target);
            const csrfToken = getCookie("csrftoken");
            target.disabled = true;
            try {
                const body = new URLSearchParams({ delivery_status: next });
                const response = await fetch(updateUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": csrfToken || "",
                    },
                    body,
                });
                const data = await response.json();
                if (!response.ok || !data.ok) {
                    throw new Error(data.error || "Error");
                }
                target.dataset.current = next;
            } catch (err) {
                target.value = previous;
                syncDeliverySelectStyle(target);
                alert("No se pudo actualizar el estado.");
            } finally {
                target.disabled = false;
            }
        });
    })();

    (function() {
        const addBtn = document.getElementById("add-item");
        const body = document.getElementById("items-body");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        const saleForm = addBtn?.closest("form") || document.querySelector("form[data-clear-form]");
        const clearSaleForm = saleForm?.dataset.clearForm === "1";
        const defaultWarehouseId = saleForm?.dataset.defaultWarehouse || "";
        const customerSelect = document.getElementById("id_cliente");
        const audienceSelect = document.getElementById("id_audiencia");
        const warehouseSelect = document.getElementById("id_warehouse");
        const totalVenta = document.getElementById("id_total_venta");
        const comisionMl = document.getElementById("id_comision_ml");
        const impuestosMl = document.getElementById("id_impuestos_ml");
        const descuentoTotal = document.getElementById("id_descuento_total");
        const deliveryStatus = document.getElementById("id_delivery_status");
        const audiences = JSON.parse(document.getElementById("customer-audiences").textContent || "{}");

        function syncAudience() {
            if (!customerSelect || !audienceSelect) return;
            const customerId = customerSelect.value;
            if (customerId && audiences[customerId]) {
                audienceSelect.value = audiences[customerId];
                audienceSelect.disabled = true;
            } else {
                audienceSelect.disabled = false;
            }
        }

        if (customerSelect) {
            customerSelect.addEventListener("change", syncAudience);
            syncAudience();
        }

        const syncMlFields = () => {
            if (!warehouseSelect) return;
            const isMl = warehouseSelect.options[warehouseSelect.selectedIndex]?.textContent?.toLowerCase().includes("mercadolibre");
            [totalVenta, comisionMl, impuestosMl].forEach((field) => {
                if (!field) return;
                const wrapper = field.closest("p") || field.parentElement;
                if (wrapper) wrapper.style.display = isMl ? "" : "none";
            });
            [descuentoTotal].forEach((field) => {
                if (!field) return;
                const wrapper = field.closest("p") || field.parentElement;
                if (wrapper) wrapper.style.display = isMl ? "none" : "";
            });
            if (deliveryStatus) {
                const wrapper = deliveryStatus.closest("p") || deliveryStatus.parentElement;
                if (wrapper) wrapper.style.display = isMl ? "none" : "";
            }
            if (customerSelect) {
                customerSelect.value = isMl ? "" : customerSelect.value;
                customerSelect.disabled = isMl;
            }
            if (audienceSelect) {
                if (isMl) {
                    audienceSelect.value = "CONSUMER";
                    audienceSelect.disabled = true;
                } else if (!customerSelect?.value) {
                    audienceSelect.disabled = false;
                }
            }
        };
        if (warehouseSelect) {
            warehouseSelect.addEventListener("change", syncMlFields);
            if (clearSaleForm && defaultWarehouseId) {
                warehouseSelect.value = defaultWarehouseId;
            }
            syncMlFields();
        }
        if (clearSaleForm) {
            [totalVenta, comisionMl, impuestosMl].forEach((field) => {
                if (field) field.value = "";
            });
        }

        if (!addBtn || !body || !totalForms) return;
        const saleDateInput = document.querySelector("input[type='date'][name='sale_date']");
        if (saleDateInput && !saleDateInput.dataset.pickerReady) {
            saleDateInput.dataset.pickerReady = "1";
            saleDateInput.addEventListener("dblclick", () => {
                if (typeof saleDateInput.showPicker === "function") {
                    saleDateInput.showPicker();
                } else {
                    saleDateInput.focus();
                }
            });
        }
        const variantDataNode = document.getElementById("sale-variant-data");
        const variantData = variantDataNode ? JSON.parse(variantDataNode.textContent) : {};
        const updateVariantSelect = (selectEl) => {
            const row = selectEl?.closest("tr");
            const variantSelect = row?.querySelector("select[name$='-variant_id']");
            if (!variantSelect) return;
            const productId = selectEl.value;
            const variants = variantData[productId] || [];
            variantSelect.innerHTML = "";
            if (!variants.length) {
                const option = document.createElement("option");
                option.value = "";
                option.textContent = "Sin variedades";
                variantSelect.appendChild(option);
                variantSelect.disabled = true;
                return;
            }
            const empty = document.createElement("option");
            empty.value = "";
            empty.textContent = "Seleccioná variedad";
            variantSelect.appendChild(empty);
            variants.forEach((variant) => {
                const option = document.createElement("option");
                option.value = variant.id;
                option.textContent = variant.name;
                variantSelect.appendChild(option);
            });
            variantSelect.disabled = false;
            const selected = variantSelect.dataset.selected || "";
            if (selected) {
                variantSelect.value = selected;
            }
        };

        const updateSearchFromSelect = (selectEl) => {
            const searchInput = selectEl?._searchInput;
            if (!searchInput) return;
            const selectedText = selectEl.options[selectEl.selectedIndex]?.textContent || "";
            searchInput.value = selectedText;
            updateVariantSelect(selectEl);
        };

        const setupProductSearch = (selectEl) => {
            if (!selectEl) return;
            if (selectEl.dataset.searchReady === "1") return;
            selectEl.dataset.searchReady = "1";
            selectEl.style.display = "none";
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.gap = "6px";
            const search = document.createElement("input");
            search.type = "text";
            search.placeholder = "Buscar producto...";
            search.name = (selectEl.name || "").replace("-product", "-product_text");
            const datalist = document.createElement("datalist");
            const listId = `product-options-${Math.random().toString(36).slice(2)}`;
            datalist.id = listId;
            search.setAttribute("list", listId);
            selectEl._searchInput = search;
            selectEl._searchList = datalist;
            Array.from(selectEl.options).forEach((opt) => {
                const option = document.createElement("option");
                option.value = opt.textContent || "";
                option.dataset.value = opt.value;
                datalist.appendChild(option);
            });
            selectEl.parentElement.insertBefore(wrapper, selectEl);
            wrapper.appendChild(search);
            wrapper.appendChild(datalist);
            wrapper.appendChild(selectEl);
            const initialLabel = selectEl.options[selectEl.selectedIndex]?.textContent || "";
            if (initialLabel) {
                search.value = initialLabel;
            }
            if (clearSaleForm) {
                selectEl.value = "";
                search.value = "";
            }

            const syncSelection = () => {
                const raw = (search.value || "").trim();
                if (!raw) return;
                const opts = Array.from(datalist.options);
                let match = opts.find((opt) => opt.value === raw);
                if (!match) {
                    const lowered = raw.toLowerCase();
                    match = opts.find((opt) => (opt.value || "").toLowerCase() === lowered);
                }
                if (!match) {
                    const lowered = raw.toLowerCase();
                    const candidates = opts.filter((opt) => (opt.value || "").toLowerCase().includes(lowered));
                    if (candidates.length >= 1) {
                        match = candidates[0];
                    }
                }
                if (match) {
                    selectEl.value = match.dataset.value || "";
                    updateSearchFromSelect(selectEl);
                }
            };
            selectEl._syncSelection = syncSelection;
            search.addEventListener("change", syncSelection);
            search.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    syncSelection();
                }
            });
            requestAnimationFrame(() => updateSearchFromSelect(selectEl));
        };

        document.querySelectorAll("select[name$='-product']").forEach(setupProductSearch);
        document.querySelectorAll("select[name$='-product']").forEach(updateVariantSelect);

        addBtn.addEventListener("click", () => {
            const idx = parseInt(totalForms.value, 10);
            const emptyHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, `${idx}`);
            const container = document.createElement("div");
            container.innerHTML = emptyHtml;

            const tr = document.createElement("tr");
            const product = container.querySelector("[name$='-product']");
            const variant = document.createElement("select");
            variant.name = `form-${idx}-variant_id`;
            variant.className = "variant-select";
            variant.dataset.selected = "";
            const qty = container.querySelector("[name$='-quantity']");
            const discount = container.querySelector("[name$='-discount_percent']");
            const vat = container.querySelector("[name$='-vat_percent']");
            [product, variant, qty, discount, vat].forEach(field => {
                const td = document.createElement("td");
                if (field) td.appendChild(field);
                tr.appendChild(td);
            });

            totalForms.value = idx + 1;
            body.appendChild(tr);
            setupProductSearch(tr.querySelector("select[name$='-product']"));
            updateVariantSelect(tr.querySelector("select[name$='-product']"));
        });

        const formEl = addBtn.closest("form");
        formEl?.addEventListener("submit", () => {
            document.querySelectorAll("select[name$='-product']").forEach((selectEl) => {
                if (typeof selectEl._syncSelection === "function") {
                    selectEl._syncSelection();
                }
            });
            const rows = Array.from(body.querySelectorAll("tr"));
            let total = parseInt(totalForms.value, 10);
            const isEmptyRow = (row) => {
                const product = row.querySelector("select[name$='-product']");
                const qty = row.querySelector("input[name$='-quantity']");
                const productValue = (product?.value || "").trim();
                const searchValue = (product?._searchInput?.value || "").trim();
                const qtyValue = (qty?.value || "").trim();
                return !productValue && !searchValue && !qtyValue;
            };
            while (rows.length && isEmptyRow(rows[rows.length - 1])) {
                rows[rows.length - 1].remove();
                rows.pop();
                total = Math.max(0, total - 1);
            }
            totalForms.value = total;
        });
    })();

    function initBulkSelect() {
        const selectAllBtn = document.getElementById("bulk-select-all");
        const startInput = document.getElementById("bulk-select-start");
        const endInput = document.getElementById("bulk-select-end");
        if (!selectAllBtn || selectAllBtn.dataset.bound === "1") return;
        selectAllBtn.dataset.bound = "1";

        const toDate = (value) => {
            if (!value) return null;
            const parts = value.split("-");
            if (parts.length !== 3) return null;
            return new Date(`${parts[0]}-${parts[1]}-${parts[2]}T00:00:00`);
        };

        selectAllBtn.addEventListener("click", () => {
            const startDate = toDate(startInput?.value);
            const endDate = toDate(endInput?.value);
            const rows = Array.from(document.querySelectorAll("tbody tr[data-created]"));
            rows.forEach((row) => {
                const checkbox = row.querySelector("input[type='checkbox'][name='sale_ids']");
                if (!checkbox) return;
                const createdRaw = row.getAttribute("data-created");
                const created = createdRaw ? new Date(createdRaw) : null;
                if (!created || (startDate && created < startDate) || (endDate && created > new Date(endDate.getTime() + 86400000 - 1))) {
                    checkbox.checked = false;
                    return;
                }
                checkbox.checked = true;
            });
        });
    }
    initBulkSelect();
</script>
{% endblock %}
