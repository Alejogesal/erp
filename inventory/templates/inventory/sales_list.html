{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Ventas{% endblock %}
{% block content %}
<h1>Ventas</h1>
<p class="subtitle">Registrá ventas y consultá comprobantes emitidos.</p>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Importar ventas MercadoLibre (Excel)</div>
    <form method="post" action="{% url 'inventory_sales_list' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="import_ml_sales_xlsx">
        <p style="color: var(--muted); margin: 0 0 10px;">
            Columnas requeridas: Fecha, Producto, Cantidad, Precio Bruto Venta, Comision, Impuestos.
        </p>
        <input type="file" name="file" accept=".xlsx" required>
        <button type="submit" style="margin-top:10px;">Importar ventas</button>
    </form>
</div>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Eliminar ventas en lote</div>
    <form method="post" action="{% url 'inventory_sales_list' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="bulk_delete_sales">
        <div class="cards" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                <label for="bulk_start">Desde</label>
                <input id="bulk_start" name="bulk_start" type="datetime-local">
            </div>
            <div>
                <label for="bulk_end">Hasta</label>
                <input id="bulk_end" name="bulk_end" type="datetime-local">
            </div>
            <div style="display:flex; align-items:center; gap:8px; padding-top:22px;">
                <input id="bulk_only_ml" name="bulk_only_ml" type="checkbox" value="1">
                <label for="bulk_only_ml">Solo MercadoLibre</label>
            </div>
        </div>
        <div style="margin-top:12px;">
            <button type="submit" onclick="return confirm('¿Eliminar ventas según el filtro?');">Eliminar ventas</button>
        </div>
    </form>
</div>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Registrar venta</div>
    <form method="post" action="{% url 'inventory_sales_list' %}">
        {% csrf_token %}
        <h3>Datos de la venta</h3>
        {{ form.as_p }}
        {{ formset.non_form_errors }}
        <h3>Productos</h3>
        {{ formset.management_form }}
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>IVA %</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="items-body">
                {% for item_form in formset.forms %}
                <tr>
                    <td>{{ item_form.product }}</td>
                    <td>{{ item_form.quantity }}</td>
                    <td>{{ item_form.vat_percent }}</td>
                    <td>{% if formset.can_delete %}{{ item_form.DELETE }}{% endif %}</td>
                </tr>
                {% if item_form.errors %}
                <tr>
                    <td colspan="4">{{ item_form.errors }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="add-item">Agregar producto</button>
        <button type="submit">Registrar venta</button>
    </form>
</div>

<div class="card table-card">
    <div class="card-title" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <span>Historial de ventas</span>
        <div style="font-size:12px; color:var(--muted); display:flex; align-items:center; gap:10px;">
            <label>Desde <input id="bulk-select-start" type="date" style="margin-left:6px;"></label>
            <label>Hasta <input id="bulk-select-end" type="date" style="margin-left:6px;"></label>
        </div>
    </div>
    <form method="get" id="history-filter" style="margin:10px 0 12px;">
        <div class="cards" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                <label for="q">Buscar</label>
                <input id="q" name="q" type="text" value="{{ search_query }}" placeholder="Cliente o producto">
            </div>
            <div style="display:flex; align-items:center; gap:12px; padding-top:22px;">
                <label style="display:flex; gap:6px; align-items:center;">
                    <input type="checkbox" name="wh_comun" value="1" {% if include_comun %}checked{% endif %}>
                    Depósito Común
                </label>
                <label style="display:flex; gap:6px; align-items:center;">
                    <input type="checkbox" name="wh_ml" value="1" {% if include_ml %}checked{% endif %}>
                    MercadoLibre
                </label>
            </div>
        </div>
    </form>
    <form method="post" action="{% url 'inventory_sales_list' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="bulk_delete_selected">
        <div style="display:flex; justify-content:flex-end; margin:6px 0 10px;">
            <div style="display:flex; flex-direction:column; align-items:flex-start; gap:6px;">
                <button type="button" id="bulk-select-all" class="pill" style="font-size:12px; padding:4px 8px;">Seleccionar todas</button>
                <button type="submit" class="pill" onclick="return confirm('¿Eliminar ventas seleccionadas?');" style="font-size:12px; padding:4px 8px;">Eliminar seleccionadas</button>
            </div>
        </div>
        <h4 style="margin:10px 0 6px;">Depósito Común</h4>
        <table>
        <thead>
            <tr>
                <th>Comprobante</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Depósito</th>
                <th>Total</th>
                <th>Comisión ML</th>
                <th>Impuestos ML</th>
                <th>Margen</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales_comun %}
            <tr class="sale-row" data-created="{{ sale.created_at|date:'c' }}" data-search="{% if sale.customer %}{{ sale.customer.name }}{% endif %} {% for item in sale.items.all %}{{ item.product.name }} {{ item.product.sku }} {% endfor %}">
                <td>{{ sale.ml_order_id|default:sale.invoice_number }}</td>
                <td>{{ sale.created_at|date:"d/m/Y H:i" }}</td>
                <td>{{ sale.customer|default:"Consumidor final" }}</td>
                <td>{{ sale.warehouse.name }}</td>
                <td>${{ sale.total|latam_number:2 }}</td>
                <td>${{ sale.ml_commission_total|latam_number:2 }}</td>
                <td>${{ sale.ml_tax_total|latam_number:2 }}</td>
                <td>${{ sale.margin_total|latam_number:2 }}</td>
                <td>
                    <a class="pill" href="{% url 'inventory_sale_receipt' sale.id %}" style="font-size:12px; padding:4px 8px;">Ver</a>
                    <a class="pill" href="{% url 'inventory_sale_receipt_pdf' sale.id %}" style="font-size:12px; padding:4px 8px;">PDF</a>
                    <a class="pill" href="{% url 'inventory_sale_edit' sale.id %}" style="font-size:12px; padding:4px 8px;">Editar</a>
                    <input type="checkbox" name="sale_ids" value="{{ sale.id }}" style="margin-left:8px;">
                </td>
            </tr>
            {% empty %}
            <tr class="empty-row"><td colspan="9">No hay ventas en Depósito Común.</td></tr>
            {% endfor %}
            {% if sales_comun %}
            <tr class="empty-row" style="display:none;"><td colspan="9">No hay ventas en Depósito Común.</td></tr>
            {% endif %}
        </tbody>
        </table>
        <h4 style="margin:16px 0 6px;">MercadoLibre</h4>
        <table>
        <thead>
            <tr>
                <th>Comprobante</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Depósito</th>
                <th>Total</th>
                <th>Comisión ML</th>
                <th>Impuestos ML</th>
                <th>Margen</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales_ml %}
            <tr class="sale-row" data-created="{{ sale.created_at|date:'c' }}" data-search="{% if sale.customer %}{{ sale.customer.name }}{% endif %} {% for item in sale.items.all %}{{ item.product.name }} {{ item.product.sku }} {% endfor %}">
                <td>{{ sale.ml_order_id|default:sale.invoice_number }}</td>
                <td>{{ sale.created_at|date:"d/m/Y H:i" }}</td>
                <td>{{ sale.customer|default:"Consumidor final" }}</td>
                <td>{{ sale.warehouse.name }}</td>
                <td>${{ sale.total|latam_number:2 }}</td>
                <td>${{ sale.ml_commission_total|latam_number:2 }}</td>
                <td>${{ sale.ml_tax_total|latam_number:2 }}</td>
                <td>${{ sale.margin_total|latam_number:2 }}</td>
                <td>
                    <a class="pill" href="{% url 'inventory_sale_receipt' sale.id %}" style="font-size:12px; padding:4px 8px;">Ver</a>
                    <a class="pill" href="{% url 'inventory_sale_receipt_pdf' sale.id %}" style="font-size:12px; padding:4px 8px;">PDF</a>
                    <a class="pill" href="{% url 'inventory_sale_edit' sale.id %}" style="font-size:12px; padding:4px 8px;">Editar</a>
                    <input type="checkbox" name="sale_ids" value="{{ sale.id }}" style="margin-left:8px;">
                </td>
            </tr>
            {% empty %}
            <tr class="empty-row"><td colspan="9">No hay ventas de MercadoLibre.</td></tr>
            {% endfor %}
            {% if sales_ml %}
            <tr class="empty-row" style="display:none;"><td colspan="9">No hay ventas de MercadoLibre.</td></tr>
            {% endif %}
        </tbody>
        </table>
    </form>
</div>
{{ customer_audiences|json_script:"customer-audiences" }}
<script>
    (function() {
        const form = document.getElementById("history-filter");
        const queryInput = document.getElementById("q");
        const whComun = form ? form.querySelector("input[name='wh_comun']") : null;
        const whMl = form ? form.querySelector("input[name='wh_ml']") : null;
        const tables = Array.from(document.querySelectorAll(".card.table-card table"));
        const comunTable = tables[0] || null;
        const mlTable = tables[1] || null;

        const normalize = (value) => (value || "").toString().toLowerCase();

        const filterTable = (table, enabled, hasFilters, query) => {
            if (!table) return;
            const rows = Array.from(table.querySelectorAll("tbody tr.sale-row"));
            let visibleCount = 0;
            rows.forEach((row) => {
                const haystack = normalize(row.dataset.search);
                const matches = !query || haystack.includes(query);
                const shouldShow = enabled ? matches : (!hasFilters ? matches : false);
                row.style.display = shouldShow ? "" : "none";
                if (shouldShow) visibleCount += 1;
            });
            const emptyRow = table.querySelector("tbody tr.empty-row");
            if (emptyRow) {
                emptyRow.style.display = visibleCount === 0 ? "" : "none";
            }
            const heading = table.previousElementSibling;
            if (heading && heading.tagName === "H4") {
                heading.style.display = (enabled || !hasFilters) ? "" : "none";
            }
            table.style.display = (enabled || !hasFilters) ? "" : "none";
        };

        const applyFilter = () => {
            const query = normalize(queryInput ? queryInput.value : "");
            const showComun = whComun ? whComun.checked : false;
            const showMl = whMl ? whMl.checked : false;
            const hasFilters = showComun || showMl;
            filterTable(comunTable, showComun, hasFilters, query);
            filterTable(mlTable, showMl, hasFilters, query);
        };

        if (form) {
            form.addEventListener("submit", (event) => event.preventDefault());
        }
        if (queryInput) {
            queryInput.addEventListener("input", applyFilter);
        }
        [whComun, whMl].forEach((checkbox) => {
            if (checkbox) checkbox.addEventListener("change", applyFilter);
        });
        applyFilter();
    })();

    (function() {
        const addBtn = document.getElementById("add-item");
        const body = document.getElementById("items-body");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        const customerSelect = document.getElementById("id_cliente");
        const audienceSelect = document.getElementById("id_audiencia");
        const warehouseSelect = document.getElementById("id_warehouse");
        const totalVenta = document.getElementById("id_total_venta");
        const comisionMl = document.getElementById("id_comision_ml");
        const impuestosMl = document.getElementById("id_impuestos_ml");
        const audiences = JSON.parse(document.getElementById("customer-audiences").textContent || "{}");

        function syncAudience() {
            if (!customerSelect || !audienceSelect) return;
            const customerId = customerSelect.value;
            if (customerId && audiences[customerId]) {
                audienceSelect.value = audiences[customerId];
                audienceSelect.disabled = true;
            } else {
                audienceSelect.disabled = false;
            }
        }

        if (customerSelect) {
            customerSelect.addEventListener("change", syncAudience);
            syncAudience();
        }

        const syncMlFields = () => {
            if (!warehouseSelect) return;
            const isMl = warehouseSelect.options[warehouseSelect.selectedIndex]?.textContent?.toLowerCase().includes("mercadolibre");
            [totalVenta, comisionMl, impuestosMl].forEach((field) => {
                if (!field) return;
                const wrapper = field.closest("p") || field.parentElement;
                if (wrapper) wrapper.style.display = isMl ? "" : "none";
            });
        };
        if (warehouseSelect) {
            warehouseSelect.addEventListener("change", syncMlFields);
            syncMlFields();
        }

        if (!addBtn || !body || !totalForms) return;
        const updateSearchFromSelect = (selectEl) => {
            const searchInput = selectEl?._searchInput;
            if (!searchInput) return;
            const selectedText = selectEl.options[selectEl.selectedIndex]?.textContent || "";
            searchInput.value = selectedText;
        };

        const setupProductSearch = (selectEl) => {
            if (!selectEl) return;
            if (selectEl.dataset.searchReady === "1") return;
            selectEl.dataset.searchReady = "1";
            selectEl.style.display = "none";
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.gap = "6px";
            const search = document.createElement("input");
            search.type = "text";
            search.placeholder = "Buscar producto...";
            const datalist = document.createElement("datalist");
            const listId = `product-options-${Math.random().toString(36).slice(2)}`;
            datalist.id = listId;
            search.setAttribute("list", listId);
            selectEl._searchInput = search;
            selectEl._searchList = datalist;
            Array.from(selectEl.options).forEach((opt) => {
                const option = document.createElement("option");
                option.value = opt.textContent || "";
                option.dataset.value = opt.value;
                datalist.appendChild(option);
            });
            selectEl.parentElement.insertBefore(wrapper, selectEl);
            wrapper.appendChild(search);
            wrapper.appendChild(datalist);
            wrapper.appendChild(selectEl);
            const initialLabel = selectEl.options[selectEl.selectedIndex]?.textContent || "";
            if (initialLabel) {
                search.value = initialLabel;
            }

            const syncSelection = () => {
                const match = Array.from(datalist.options).find((opt) => opt.value === search.value);
                if (match) {
                    selectEl.value = match.dataset.value || "";
                    updateSearchFromSelect(selectEl);
                }
            };
            selectEl._syncSelection = syncSelection;
            search.addEventListener("change", syncSelection);
            search.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    syncSelection();
                }
            });
            requestAnimationFrame(() => updateSearchFromSelect(selectEl));
        };

        document.querySelectorAll("select[name$='-product']").forEach(setupProductSearch);

        addBtn.addEventListener("click", () => {
            const idx = parseInt(totalForms.value, 10);
            const emptyHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, `form-${idx}`);
            const container = document.createElement("div");
            container.innerHTML = emptyHtml;

            const tr = document.createElement("tr");
            const product = container.querySelector("[name$='-product']");
            const qty = container.querySelector("[name$='-quantity']");
            const vat = container.querySelector("[name$='-vat_percent']");
            const deleteField = container.querySelector("[name$='-DELETE']");

            [product, qty, vat, deleteField].forEach(field => {
                const td = document.createElement("td");
                if (field) td.appendChild(field);
                tr.appendChild(td);
            });

            totalForms.value = idx + 1;
            body.appendChild(tr);
            setupProductSearch(tr.querySelector("select[name$='-product']"));
        });

        const formEl = addBtn.closest("form");
        const storageKey = "erp:sales_draft";

        const serializeRow = (row) => {
            const productSelect = row.querySelector("select[name$='-product']");
            const qtyInput = row.querySelector("input[name$='-quantity']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            const searchInput = productSelect?._searchInput;
            const data = {
                product_id: productSelect?.value || "",
                product_search: searchInput?.value || "",
                quantity: qtyInput?.value || "",
                vat_percent: vatInput?.value || "",
            };
            const hasValue = Object.values(data).some((value) => value);
            return hasValue ? data : null;
        };

        let suppressDraftSave = false;
        const saveDraft = () => {
            if (suppressDraftSave) return;
            if (!formEl) return;
            const header = {};
            ["warehouse", "audiencia", "cliente", "total_venta", "descuento_total", "comision_ml", "impuestos_ml"].forEach((name) => {
                const field = formEl.querySelector(`[name='${name}']`);
                if (field) header[name] = field.value || "";
            });
            const rows = Array.from(body.querySelectorAll("tr"));
            const items = rows.map(serializeRow).filter(Boolean);
            const payload = { header, items };
            localStorage.setItem(storageKey, JSON.stringify(payload));
        };

        const fillRow = (row, data) => {
            if (!data) return;
            const productSelect = row.querySelector("select[name$='-product']");
            const qtyInput = row.querySelector("input[name$='-quantity']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            if (productSelect) {
                if (data.product_id) {
                    productSelect.value = data.product_id;
                    updateSearchFromSelect(productSelect);
                } else if (productSelect._searchInput) {
                    productSelect._searchInput.value = data.product_search || "";
                }
            }
            if (qtyInput && data.quantity) qtyInput.value = data.quantity;
            if (vatInput && data.vat_percent) vatInput.value = data.vat_percent;
        };

        const restoreDraft = () => {
            const navEntry = performance.getEntriesByType?.("navigation")?.[0];
            const wasReload = navEntry ? navEntry.type === "reload" : performance.navigation?.type === 1;
            if (!wasReload) {
                localStorage.removeItem(storageKey);
                return;
            }
            const raw = localStorage.getItem(storageKey);
            if (!raw) return;
            let draft = null;
            try {
                draft = JSON.parse(raw);
            } catch (err) {
                return;
            }
            const header = draft?.header || {};
            Object.keys(header).forEach((name) => {
                const field = formEl?.querySelector(`[name='${name}']`);
                if (field && header[name]) field.value = header[name];
            });
            syncAudience();
            syncMlFields();
            const items = Array.isArray(draft?.items) ? draft.items : [];
            if (!items.length) return;
            while (body.querySelectorAll("tr").length < items.length) {
                addBtn.click();
            }
            const rows = Array.from(body.querySelectorAll("tr"));
            items.forEach((item, idx) => fillRow(rows[idx], item));
        };

        const pruneEmptyRows = () => {
            const rows = Array.from(body.querySelectorAll("tr"));
            rows.forEach((row) => {
                const productSelect = row.querySelector("select[name$='-product']");
                const qtyInput = row.querySelector("input[name$='-quantity']");
                const deleteCheckbox = row.querySelector("input[type='checkbox'][name$='-DELETE']");
                if (!productSelect || !qtyInput || !deleteCheckbox) return;
                const isEmpty = !productSelect.value && !qtyInput.value;
                if (isEmpty) {
                    deleteCheckbox.checked = true;
                }
            });
        };

        formEl?.addEventListener("input", saveDraft);
        formEl?.addEventListener("change", saveDraft);
        formEl?.addEventListener("submit", () => {
            suppressDraftSave = true;
            document.querySelectorAll("select[name$='-product']").forEach((selectEl) => {
                if (typeof selectEl._syncSelection === "function") {
                    selectEl._syncSelection();
                }
            });
            pruneEmptyRows();
            localStorage.removeItem(storageKey);
        });
        restoreDraft();
    })();

    (function() {
        const selectAllBtn = document.getElementById("bulk-select-all");
        const startInput = document.getElementById("bulk-select-start");
        const endInput = document.getElementById("bulk-select-end");
        if (!selectAllBtn) return;

        const toDate = (value) => {
            if (!value) return null;
            const parts = value.split("-");
            if (parts.length !== 3) return null;
            return new Date(`${parts[0]}-${parts[1]}-${parts[2]}T00:00:00`);
        };

        selectAllBtn.addEventListener("click", () => {
            const startDate = toDate(startInput?.value);
            const endDate = toDate(endInput?.value);
            const rows = Array.from(document.querySelectorAll("tbody tr[data-created]"));
            rows.forEach((row) => {
                const checkbox = row.querySelector("input[type='checkbox'][name='sale_ids']");
                if (!checkbox) return;
                const createdRaw = row.getAttribute("data-created");
                const created = createdRaw ? new Date(createdRaw) : null;
                if (!created || (startDate && created < startDate) || (endDate && created > new Date(endDate.getTime() + 86400000 - 1))) {
                    checkbox.checked = false;
                    return;
                }
                checkbox.checked = true;
            });
        });
    })();
</script>
{% endblock %}
