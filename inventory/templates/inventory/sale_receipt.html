{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Comprobante {{ invoice_number }}{% endblock %}
{% block content %}
{% if is_pdf %}
<style>
    @page { size: A4; margin: 10mm; }
    html, body { width: 100%; height: 100%; }
    body { background: #fff !important; color: #000 !important; margin: 0; }
    .page { max-width: 100% !important; margin: 0; padding: 0 !important; display: block !important; }
    .main { width: 100% !important; }
    .actions, .messages { display: none !important; }
</style>
{% endif %}
<style>
    .invoice-wrapper {
        background: #fff;
        color: #000;
        padding: 18px 18px 24px;
        border: 1px solid #000;
        width: 100%;
        box-sizing: border-box;
    }
    {% if is_pdf %}
    .invoice-wrapper {
        min-height: calc(297mm - 20mm);
        display: flex;
        flex-direction: column;
    }
    .invoice-body { flex: 1 1 auto; }
    .totals { margin-top: auto; }
    {% endif %}
    .invoice-header { display: grid; grid-template-columns: 1fr 2fr; align-items: center; gap: 12px; }
    .invoice-logo { text-align: center; border: 2px solid #000; padding: 16px; font-size: 28px; font-weight: 700; }
    .invoice-meta { font-size: 14px; line-height: 1.4; }
    .invoice-meta h2 { margin: 0 0 6px; font-size: 20px; }
    .info-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 12px 0; font-size: 13px; }
    .info-block strong { display: block; font-size: 12px; text-transform: uppercase; }
    table.invoice-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
    table.invoice-table th, table.invoice-table td { border-bottom: 1px solid #000; padding: 6px 4px; }
    table.invoice-table th { text-align: left; font-size: 11px; text-transform: uppercase; }
    table.invoice-table td.num { text-align: right; }
    .totals { margin-top: 10px; font-size: 13px; }
    .totals-row { display: grid; grid-template-columns: 1fr 1fr 1fr; }
    .totals-row div { text-align: right; padding: 4px 0; }
    .totals-row .label { text-align: left; }
    .right { text-align: right; }
</style>

<div class="invoice-wrapper">
    <div class="invoice-header">
        <div class="invoice-logo">X</div>
        <div class="invoice-meta">
            <h2>Comprobante</h2>
            <div>Nº {{ invoice_number }}</div>
            <div>Fecha: {{ sale.created_at|date:"d/m/Y" }}</div>
        </div>
    </div>

    <div class="info-row" style="border-top:1px solid #000; padding-top:8px; margin-top:10px;">
        <div class="info-block"><strong>Razón Social:</strong> {{ sale.customer|default:"Consumidor final" }}</div>
        <div class="info-block"><strong>Dirección:</strong> </div>
        <div class="info-block"><strong>Localidad:</strong> </div>
        <div class="info-block right">
            <div><strong>I.V.A.:</strong></div>
            <div><strong>C.U.I.T.:</strong></div>
            <div><strong>Cond. Vta:</strong></div>
        </div>
    </div>

    <div class="invoice-body">
    <table class="invoice-table">
        <thead>
            <tr>
                <th>Descripción</th>
                <th class="num">Cantidad</th>
                <th class="num">Precio</th>
                <th class="num">Dto</th>
                <th class="num">Importe</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.product.name }}</td>
                <td class="num">{{ item.quantity|latam_number:2 }}</td>
                <td class="num">${{ item.unit_price|latam_number:2 }}</td>
                <td class="num">
                    {% if item.discount_percent %}
                        -{{ item.discount_percent|latam_number:0 }}%
                    {% elif extra_discount_percent %}
                        -{{ extra_discount_percent|latam_number:0 }}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
                <td class="num">${{ item.line_total|latam_number:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>

    <div class="totals" style="border-top:1px solid #000; padding-top:8px; margin-top:12px;">
        <div class="totals-row">
            <div class="label">Subtotal</div>
            <div></div>
            <div>${{ subtotal|latam_number:2 }}</div>
        </div>
        <div class="totals-row">
            <div class="label">Descuento</div>
            <div></div>
            <div>${{ discount_total|latam_number:2 }}</div>
        </div>
        {% if is_ml %}
        <div class="totals-row">
            <div class="label">Comisión ML</div>
            <div></div>
            <div>${{ commission_total|latam_number:2 }}</div>
        </div>
        <div class="totals-row">
            <div class="label">Impuestos ML</div>
            <div></div>
            <div>${{ tax_total|latam_number:2 }}</div>
        </div>
        {% endif %}
        <div class="totals-row" style="font-weight:700;">
            <div class="label">Total</div>
            <div></div>
            <div>${{ total|latam_number:2 }}</div>
        </div>
        {% if is_ml %}
        <div class="totals-row" style="font-weight:700;">
            <div class="label">Neto ML</div>
            <div></div>
            <div>${{ net_total|latam_number:2 }}</div>
        </div>
        {% endif %}
    </div>
</div>

{% if not is_pdf %}
<div class="actions" style="margin-top:12px;">
    <a class="pill" href="{% url 'inventory_sale_edit' sale.id %}">Editar venta</a>
    <a class="pill" href="{% url 'inventory_sale_receipt_pdf' sale.id %}">Descargar PDF</a>
    <a class="pill" href="{% url 'inventory_dashboard' %}">Volver al dashboard</a>
</div>
{% endif %}
{% endblock %}
