{% extends "inventory/base.html" %}
{% load latam_numbers %}
{% block title %}Editar compra {{ purchase.invoice_number }}{% endblock %}
{% block content %}
<h1>Editar compra</h1>
<p class="subtitle">Actualizá productos y cantidades.</p>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Compra Nº {{ purchase.invoice_number }}</div>
    <form method="post">
        {% csrf_token %}
        <h3>Depósito</h3>
        {{ form.as_p }}
        {{ formset.non_form_errors }}
        <div style="display:flex; align-items:center; gap:10px; margin:10px 0;">
            <button type="button" id="toggle-vat">Mostrar IVA</button>
        </div>
        <h3>Productos</h3>
        {{ formset.management_form }}
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Proveedor</th>
                    <th>Cantidad</th>
                    <th>Costo unitario (con IVA)</th>
                    <th class="vat-col">IVA %</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="items-body">
                {% for item_form in formset.forms %}
                <tr>
                    <td>{{ item_form.product }}</td>
                    <td>{{ item_form.supplier }}</td>
                    <td>{{ item_form.quantity }}</td>
                    <td>{{ item_form.unit_cost }}</td>
                    <td class="vat-col">{{ item_form.vat_percent }}</td>
                    <td>{% if formset.can_delete %}{{ item_form.DELETE }}{% endif %}</td>
                </tr>
                {% if item_form.errors %}
                <tr>
                    <td colspan="6">{{ item_form.errors }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="add-item">Agregar producto</button>
        <button type="submit">Guardar cambios</button>
    </form>
</div>

<div class="actions">
    <a class="pill" href="{% url 'inventory_purchase_receipt' purchase.id %}">Volver al comprobante</a>
</div>

<script>
    (function() {
        const addBtn = document.getElementById("add-item");
        const body = document.getElementById("items-body");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        if (!addBtn || !body || !totalForms) return;

        addBtn.addEventListener("click", () => {
            const idx = parseInt(totalForms.value, 10);
            const emptyHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, `form-${idx}`);
            const container = document.createElement("div");
            container.innerHTML = emptyHtml;

            const tr = document.createElement("tr");
            const product = container.querySelector("[name$='-product']");
            const supplier = container.querySelector("[name$='-supplier']");
            const qty = container.querySelector("[name$='-quantity']");
            const cost = container.querySelector("[name$='-unit_cost']");
            const vat = container.querySelector("[name$='-vat_percent']");
            const deleteField = container.querySelector("[name$='-DELETE']");

            [product, supplier, qty, cost, vat, deleteField].forEach(field => {
                const td = document.createElement("td");
                if (field) td.appendChild(field);
                if (field && field.name?.includes("vat_percent")) td.classList.add("vat-col");
                tr.appendChild(td);
            });

            totalForms.value = idx + 1;
            body.appendChild(tr);
        });

        const toggleVat = document.getElementById("toggle-vat");
        if (toggleVat) {
            toggleVat.addEventListener("click", () => {
                const cols = document.querySelectorAll(".vat-col");
                cols.forEach((col) => {
                    col.style.display = col.style.display === "none" ? "" : "none";
                });
            });
            document.querySelectorAll(".vat-col").forEach((col) => (col.style.display = "none"));
        }
    })();
</script>
{% endblock %}
