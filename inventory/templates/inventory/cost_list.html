{% extends "inventory/base.html" %}
{% block title %}Productos{% endblock %}
{% block content %}
<style>
    .page { max-width: 1400px; }
    .product-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #0f1622;
        border: 1px solid #2a313c;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
    }
    .product-filter input {
        background: transparent;
        border: none;
        color: var(--text);
        width: 100%;
        padding: 4px 2px;
        font-size: 14px;
    }
    .product-filter input:focus { outline: none; }
    .product-filter .hint {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.3px;
        text-transform: uppercase;
        white-space: nowrap;
    }
    .danger {
        background: var(--negative);
    }
    .danger.small {
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 8px;
    }
    .autosave-status {
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
    }
    .product-form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
    }
    .product-form-grid .full {
        grid-column: 1 / -1;
    }
    .product-advanced {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #2a313c;
        background: #0f1622;
    }
    .product-advanced summary {
        cursor: pointer;
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }
    .product-advanced[open] summary { margin-bottom: 10px; }
    #productos table {
        table-layout: auto;
    }
    #productos table input,
    #productos table select {
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 13px;
    }
    #productos table th:first-child,
    #productos table td:first-child {
        min-width: 260px;
        width: 36%;
    }
    #productos input[name$='-name'] {
        width: 100%;
        min-width: 320px;
    }
</style>
<h1>Productos</h1>
<p class="subtitle">Cargá productos y editá costos, nombre y proveedor. El SKU se genera automáticamente.</p>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Nuevo producto</div>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_product">
        <div class="product-form-grid">
            <div>
                {{ product_form.name.label_tag }}
                {{ product_form.name }}
                {{ product_form.name.errors }}
            </div>
            <div>
                {{ product_form.group.label_tag }}
                {{ product_form.group }}
                {{ product_form.group.errors }}
            </div>
            <div>
                {{ product_form.avg_cost.label_tag }}
                {{ product_form.avg_cost }}
                {{ product_form.avg_cost.errors }}
            </div>
            <div>
                {{ product_form.vat_percent.label_tag }}
                {{ product_form.vat_percent }}
                {{ product_form.vat_percent.errors }}
            </div>
            <div class="full">
                {{ product_form.default_supplier.label_tag }}
                {{ product_form.default_supplier }}
                {{ product_form.default_supplier.errors }}
            </div>
            <div class="full">
                <details class="product-advanced">
                    <summary>Margenes (opcional)</summary>
                    <div class="product-form-grid">
                        <div>
                            {{ product_form.margin_consumer.label_tag }}
                            {{ product_form.margin_consumer }}
                            {{ product_form.margin_consumer.errors }}
                        </div>
                        <div>
                            {{ product_form.margin_barber.label_tag }}
                            {{ product_form.margin_barber }}
                            {{ product_form.margin_barber.errors }}
                        </div>
                        <div>
                            {{ product_form.margin_distributor.label_tag }}
                            {{ product_form.margin_distributor }}
                            {{ product_form.margin_distributor.errors }}
                        </div>
                    </div>
                </details>
            </div>
        </div>
        <button type="submit">Guardar producto</button>
    </form>
</div>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Importar costos</div>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="import_costs">
        <p>
            <label for="file">Archivo XLSX</label>
            <input id="file" name="file" type="file" accept=".xlsx">
        </p>
        <button type="submit">Importar</button>
    </form>
</div>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Eliminar productos importados</div>
    <form method="post" enctype="multipart/form-data" onsubmit="return confirm('¿Eliminar productos del archivo? Solo se borran los que no tienen movimientos.');">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_import">
        <p>
            <label for="delete_file">Archivo XLSX</label>
            <input id="delete_file" name="file" type="file" accept=".xlsx">
        </p>
        <button type="submit">Eliminar importación</button>
    </form>
</div>

<div class="card" style="margin-bottom:16px;">
    <div class="card-title">Edición masiva</div>
    {% if bulk_form.errors %}
        {{ bulk_form.errors }}
    {% endif %}
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="bulk_update">
        <div class="product-form-grid">
            <div>
                {{ bulk_form.group.label_tag }}
                {{ bulk_form.group }}
            </div>
            <div>
                {{ bulk_form.supplier.label_tag }}
                {{ bulk_form.supplier }}
            </div>
            <div>
                {{ bulk_form.cost_percent.label_tag }}
                {{ bulk_form.cost_percent }}
                <div class="autosave-status">Si dejás Marca/Grupo vacío, aplica a toda la lista.</div>
            </div>
            <div>
                {{ bulk_form.margin_consumer.label_tag }}
                {{ bulk_form.margin_consumer }}
            </div>
            <div>
                {{ bulk_form.margin_barber.label_tag }}
                {{ bulk_form.margin_barber }}
            </div>
            <div>
                {{ bulk_form.margin_distributor.label_tag }}
                {{ bulk_form.margin_distributor }}
            </div>
        </div>
        <button type="submit" style="margin-top:12px;">Aplicar cambios</button>
    </form>
</div>

<div class="card table-card" id="productos">
    <div class="card-title">Productos</div>
    <div style="margin: 8px 0 12px;">
        <div class="product-filter">
            <span class="hint">Buscar</span>
            <input id="product-filter" type="text" placeholder="Producto, marca o proveedor">
        </div>
    </div>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_costs">
        {{ formset.management_form }}
        <table>
            <thead>
                <tr>
                <th>Producto</th>
                <th>Marca / Grupo</th>
                <th>Proveedor</th>
                <th>IVA %</th>
                <th>Costo unitario sin IVA</th>
                <th>Costo unitario con IVA</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
            <tr>
                    <td>
                        {{ form.product_id }}
                        {{ form.name }}
                        {{ form.name.errors }}
                        <div style="margin-top:6px; font-size:12px;">
                            <a href="{% url 'inventory_product_variants' form.product_id.value %}" style="color: var(--muted);">
                                Variedades
                            </a>
                        </div>
                    </td>
                    <td>
                        {{ form.group }}
                        {{ form.group.errors }}
                    </td>
                    <td>{{ form.supplier }}</td>
                    <td>{{ form.vat_percent }}</td>
                    <td>{{ form.avg_cost }}</td>
                    <td>
                        <input type="text" class="cost-with-vat" readonly>
                    </td>
                    <td>
                        <button type="button" class="danger small" data-product-id="{{ form.product_id.value }}">Eliminar</button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7">Aún no hay productos cargados.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top:16px;">
            <button type="submit">Guardar costos</button>
            <div class="autosave-status" id="autosave-status">Auto-guardado activo.</div>
        </div>
    </form>
</div>
<form id="delete-product-form" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="delete_product">
    <input type="hidden" name="product_id" id="delete-product-id">
</form>
<script>
    (function() {
        const key = "productos_scroll";
        const saved = sessionStorage.getItem(key);
        if (saved) {
            const y = parseInt(saved, 10);
            requestAnimationFrame(() => {
                setTimeout(() => window.scrollTo(0, y), 50);
            });
            sessionStorage.removeItem(key);
        }
        document.querySelectorAll("form").forEach(form => {
            form.addEventListener("submit", () => {
                sessionStorage.setItem(key, String(window.scrollY));
                if (!location.hash || location.hash !== "#productos") {
                    history.replaceState(null, "", "#productos");
                }
            });
        });

        const filterInput = document.getElementById("product-filter");
        if (filterInput) {
            const rows = Array.from(document.querySelectorAll("#productos tbody tr"));
            const getRowText = (row) => {
                const name = row.querySelector("input[name$='-name']")?.value || "";
                const group = row.querySelector("input[name$='-group']")?.value || "";
                const supplierSelect = row.querySelector("select");
                const supplier =
                    supplierSelect?.options[supplierSelect.selectedIndex]?.textContent || "";
                return `${name} ${group} ${supplier}`.toLowerCase();
            };
            const applyFilter = () => {
                const query = filterInput.value.trim().toLowerCase();
                rows.forEach((row) => {
                    if (!row.querySelector("input, select")) {
                        return;
                    }
                    const visible = !query || getRowText(row).includes(query);
                    row.style.display = visible ? "" : "none";
                });
            };
            filterInput.addEventListener("input", applyFilter);
        }

        const parseNumber = (value) => {
            if (!value) {
                return 0;
            }
            const raw = value.replace(/\s/g, "");
            let normalized = raw;
            const hasComma = raw.includes(",");
            const hasDot = raw.includes(".");
            if (hasComma && hasDot) {
                normalized = raw.replace(/\./g, "").replace(",", ".");
            } else if (hasComma) {
                normalized = raw.replace(",", ".");
            }
            const parsed = parseFloat(normalized);
            return Number.isNaN(parsed) ? 0 : parsed;
        };

        const formatNumber = (value) => value.toFixed(2).replace(".", ",");

        const updateVatCosts = (row) => {
            const baseInput = row.querySelector("input[name$='-avg_cost']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            const withVatInput = row.querySelector(".cost-with-vat");
            if (!baseInput || !vatInput || !withVatInput) {
                return;
            }
            const base = parseNumber(baseInput.value);
            const vat = parseNumber(vatInput.value);
            const total = base * (1 + vat / 100);
            withVatInput.value = formatNumber(total);
        };

        document.querySelectorAll("#productos tbody tr").forEach((row) => {
            const baseInput = row.querySelector("input[name$='-avg_cost']");
            const vatInput = row.querySelector("input[name$='-vat_percent']");
            if (baseInput && vatInput) {
                baseInput.addEventListener("input", () => updateVatCosts(row));
                vatInput.addEventListener("input", () => updateVatCosts(row));
                updateVatCosts(row);
            }
        });

        const deleteForm = document.getElementById("delete-product-form");
        const deleteInput = document.getElementById("delete-product-id");
        document.querySelectorAll("#productos button.danger").forEach((button) => {
            button.addEventListener("click", () => {
                const productId = button.getAttribute("data-product-id");
                if (!productId) {
                    return;
                }
                if (!confirm("¿Eliminar este producto?")) {
                    return;
                }
                deleteInput.value = productId;
                deleteForm.submit();
            });
        });

        const status = document.getElementById("autosave-status");
        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
            return "";
        };
        const csrfToken = getCookie("csrftoken");
        const timers = new Map();
        const autosave = (row) => {
            const productId = row.querySelector("input[name$='-product_id']")?.value;
            const avgCostInput = row.querySelector("input[name$='-avg_cost']");
            if (!productId || !avgCostInput) return;
            const payload = new FormData();
            payload.append("action", "quick_update_cost");
            payload.append("product_id", productId);
            payload.append("avg_cost", avgCostInput.value || "");
            fetch(window.location.href, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken || "",
                },
                body: payload,
                credentials: "same-origin",
            }).then(() => {
                if (status) status.textContent = "Auto-guardado activo.";
            }).catch(() => {
                if (status) status.textContent = "No se pudo auto-guardar.";
            });
        };

        document.querySelectorAll("#productos tbody tr").forEach((row) => {
            const avgCostInput = row.querySelector("input[name$='-avg_cost']");
            if (!avgCostInput) return;
            avgCostInput.addEventListener("input", () => {
                if (status) status.textContent = "Guardando...";
                const key = row;
                clearTimeout(timers.get(key));
                timers.set(key, setTimeout(() => autosave(row), 400));
            });
            avgCostInput.addEventListener("blur", () => autosave(row));
        });
    })();
</script>
{% endblock %}
